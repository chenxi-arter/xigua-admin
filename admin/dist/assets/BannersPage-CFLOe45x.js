import{j as t}from"./index-DxaCQfSk.js";import{r as i}from"./react-vendor-BZ8KDC-J.js";import{C as Ve,S as Ge,a as ce,B as g}from"./admin-C9fopLaz.js";import{F as d,j as ue,s as o,h as me,B as y,i as N,a as M,g as Y,d as Ne,f as K,I as b,U as Ye,k as Ke,l as ge}from"./antd-vendor-DXNcJ2Ha.js";import{f as he}from"./format-0Cj3JWJt.js";import"./utils-vendor-NIGUFBhG.js";function et(){const U=e=>!!e&&/^(https?:)?\/\//i.test(e),[pe,J]=i.useState(!1),[Ae,fe]=i.useState([]),[ye,xe]=i.useState(0),[x,W]=i.useState(1),[p,Ie]=i.useState(10),[we,w]=i.useState(!1),[r,_]=i.useState(null),[m]=d.useForm(),j=d.useWatch("isAd",m),[$,Z]=i.useState(!1),[je,X]=i.useState(!1),[C,ee]=i.useState(""),[Se,O]=i.useState(!1),[T,Q]=i.useState(null),[ve,q]=i.useState(!1),[E,z]=i.useState(null),[te,h]=i.useState(null),[se,S]=i.useState([]),[B,ke]=i.useState(void 0),[D,ae]=i.useState(!1),[be,ie]=i.useState(1),[Ue,le]=i.useState(!0),H=i.useRef(void 0),V=i.useRef(""),G=i.useRef(1),[Ce,Te]=i.useState([]),[ne,Ee]=i.useState({}),Be=i.useCallback(async()=>{try{const e=await Ve.list(1,200),s=(e.items||[]).map(a=>({value:a.id,label:a.name||String(a.categoryId||a.id)}));Te(s);const n={};(e.items||[]).forEach(a=>{const l=a.name||String(a.categoryId||a.id);n[String(a.id)]=l,a.categoryId!==void 0&&a.categoryId!==null&&(n[String(a.categoryId)]=l)}),Ee(n)}catch{}},[]),L=50,R=i.useCallback(async e=>{const s=e?.keyword!==void 0?e.keyword:V.current,n=e?.reset?1:e?.page||G.current;ae(!0);try{if(s&&s.trim()){const a=await Ge.fuzzy({keyword:s.trim(),page:n,size:L}),l=a?.data||a,P=(l?.list||l?.items||[]).map(u=>({value:u.id,label:`#${u.id} ${u.title||""}`}));e?.reset?S(P):S(u=>{const k=new Map;return u.forEach(f=>k.set(f.value,f.label)),P.forEach(f=>k.set(f.value,f.label)),Array.from(k.entries()).map(([f,He])=>({value:f,label:He}))});const v=l?.page||n;V.current=s||"",ie(v),G.current=v;const de=l?.total??0,A=l?.size??L;le(v*A<de||l?.hasMore===!0)}else{const a=await ce.list(n,L),l=(a.items||[]).map(A=>({value:A.id,label:`#${A.id} ${A.title||""}`}));e?.reset?S(l):S(A=>{const F=new Map;return A.forEach(u=>F.set(u.value,u.label)),l.forEach(u=>F.set(u.value,u.label)),Array.from(F.entries()).map(([u,k])=>({value:u,label:k}))});const I=a.page||n;V.current="",ie(I),G.current=I;const P=a.total??0,v=a.size??L;le(I*v<P)}}catch{}finally{ae(!1)}},[]),c=i.useCallback(async(e=x,s=p,n=B)=>{J(!0);try{const a=await g.list(e,s);let l=a.items;n!==void 0&&(l=a.items.filter(I=>I.isAd===n)),fe(l),xe(n!==void 0?l.length:a.total),W(e),Ie(s)}finally{J(!1)}},[x,p,B]);i.useEffect(()=>{c(1,p),R({reset:!0}),Be()},[]);const re=i.useCallback(e=>{_(e),m.setFieldsValue({...e,startTime:e.startTime?ue(e.startTime):null,endTime:e.endTime?ue(e.endTime):null}),e.imageUrl&&U(e.imageUrl)&&h(e.imageUrl),e.seriesId&&(async()=>{try{const s=await ce.get(e.seriesId),n={value:s.id,label:`#${s.id} ${s.title||""}`};S(a=>a.find(l=>l.value===n.value)?a:[n,...a])}catch{}})(),w(!0)},[m]),oe=i.useCallback(e=>{Q(e),O(!0)},[]),De=i.useCallback(async()=>{if(T)try{await g.remove(T.id),o.success("已删除"),c()}catch{o.error("删除失败")}finally{O(!1),Q(null)}},[T,c]),Le=i.useCallback(()=>{O(!1),Q(null)},[]),Re=i.useCallback(async()=>{if(!(!r||!E))try{await g.update(r.id,E),o.success("已更新"),w(!1),h(null),c()}catch{o.error("修改失败")}finally{q(!1),z(null)}},[r,E,c]),Pe=i.useCallback(()=>{q(!1),z(null)},[]),Fe=i.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"标题",dataIndex:"title",width:240,render:e=>t.jsx("span",{className:"text-ellipsis",style:{display:"inline-block",maxWidth:240},children:e})},{title:"图片",width:260,render:(e,s)=>U(s.imageUrl)?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx(me,{src:s.imageUrl,alt:"banner",width:80,height:48,style:{objectFit:"cover",borderRadius:4}}),s.linkUrl&&t.jsx(y,{type:"link",onClick:()=>ze(s),children:"打开"})]}):"-"},{title:"分类",dataIndex:"categoryId",width:140,render:(e,s)=>ne[String(s.categoryId)]||s.categoryId},{title:"系列ID",dataIndex:"seriesId",width:100},{title:"权重",dataIndex:"weight",width:120,render:e=>e??"-"},{title:"类型",dataIndex:"isAd",render:e=>e?"广告":"关联剧集",width:80},{title:"启用",dataIndex:"isActive",width:100,render:(e,s)=>t.jsx(N,{checked:!!e,onChange:async n=>{try{await g.updateStatus(s.id,n),o.success(n?"已启用":"已禁用"),c()}catch{o.error("更新状态失败")}}})},{title:"曝光",dataIndex:"impressions",width:100},{title:"点击",dataIndex:"clicks",width:100},{title:"开始时间",dataIndex:"startTime",width:180,render:e=>he(e)},{title:"结束时间",dataIndex:"endTime",width:180,render:e=>he(e)},{title:"操作",width:220,render:(e,s)=>t.jsxs(M,{children:[t.jsx(y,{onClick:()=>re(s),type:"link",children:"编辑"}),t.jsx(y,{onClick:()=>oe(s),danger:!0,type:"link",children:"删除"})]})}],[re,oe,ne,c]),Me=()=>{_(null),m.resetFields(),h(null),w(!0)},Oe=async()=>{const e=await m.validateFields(),s=a=>a?new Date(a.valueOf()).toISOString():void 0,n={...e,startTime:s(e.startTime),endTime:s(e.endTime)};if(e.isAd?delete n.seriesId:delete n.linkUrl,r)z(n),q(!0);else try{const a={title:e.title,imageUrl:e.imageUrl,categoryId:e.categoryId,weight:e.weight,isActive:e.isActive,isAd:e.isAd,startTime:s(e.startTime),endTime:s(e.endTime),description:e.description,linkUrl:e.isAd?e.linkUrl:void 0,seriesId:e.isAd?void 0:e.seriesId};await g.create(a),o.success("已创建"),w(!1),h(null),c()}catch{o.error("创建失败")}},Qe=async e=>{const{file:s,onSuccess:n,onError:a}=e;if(!r){o.warning("新建轮播图时请直接填写图片URL，创建完成后可在编辑页面修改图片"),a?.(new Error("新建模式不支持文件上传"));return}try{Z(!0),await g.uploadImage(r.id,s);const l=await g.get(r.id);m.setFieldsValue({imageUrl:l.imageUrl}),h(l.imageUrl),o.success("图片已上传到服务器"),c(x,p),n?.({})}catch(l){a?.(l instanceof Error?l:new Error(String(l))),o.error("图片上传失败")}finally{Z(!1)}},qe=async()=>{if(!r){o.warning("新建轮播图时请直接填写图片URL，创建完成后可在编辑页面修改图片");return}if(!C||!/^https?:\/\//i.test(C)){o.warning("请输入有效的图片 URL");return}try{X(!0),await g.imageFromUrl(r.id,C.trim());const e=await g.get(r.id);m.setFieldsValue({imageUrl:e.imageUrl}),h(e.imageUrl),o.success("已通过 URL 更新图片"),ee(""),c(x,p)}catch{o.error("通过 URL 上传图片失败")}finally{X(!1)}},ze=e=>{e.linkUrl&&(window.open(e.linkUrl,"_blank"),g.click(e.id))};return t.jsxs("div",{className:"page",children:[t.jsxs(M,{className:"page-toolbar",children:[t.jsx(y,{type:"primary",onClick:Me,children:"新建轮播图"}),t.jsx(Y,{placeholder:"筛选类型",style:{width:120},allowClear:!0,value:B,onChange:e=>{ke(e),W(1),c(1,p,e)},options:[{value:!0,label:"广告"},{value:!1,label:"关联剧集"}]}),t.jsx(y,{onClick:()=>c(x,p,B),children:"刷新"})]}),t.jsx(Ne,{rowKey:"id",loading:pe,dataSource:Ae,columns:Fe,scroll:{x:1100,y:"calc(100vh - 300px)"},tableLayout:"fixed",pagination:{current:x,pageSize:p,total:ye,position:["bottomCenter"],onChange:(e,s)=>c(e,s)}}),t.jsx(K,{title:r?"编辑轮播图":"新建轮播图",open:we,onCancel:()=>{w(!1),h(null)},onOk:Oe,okText:"保存",width:720,children:t.jsxs(d,{form:m,layout:"vertical",children:[t.jsx(d.Item,{name:"title",label:"标题",rules:[{required:!0}],children:t.jsx(b,{})}),t.jsx(d.Item,{name:"isAd",label:"广告/关联剧集",valuePropName:"checked",initialValue:!1,children:t.jsx(N,{checkedChildren:"广告",unCheckedChildren:"关联剧集",onChange:e=>{e?m.setFieldsValue({seriesId:void 0}):m.setFieldsValue({linkUrl:void 0})}})}),t.jsx(d.Item,{name:"imageUrl",label:"图片URL",rules:[{required:!0}],children:t.jsx(b,{placeholder:"可直接填写图片 URL，或在下方选择图片文件",onChange:e=>{const s=e.target.value;s&&U(s)?h(s):s||h(null)}})}),(te||r?.imageUrl&&U(r.imageUrl))&&t.jsxs("div",{style:{marginBottom:16,textAlign:"center"},children:[t.jsx("div",{style:{fontSize:14,color:"#666",marginBottom:8},children:"图片预览："}),t.jsx(me,{src:te||r?.imageUrl,alt:"banner preview",style:{maxWidth:"100%",maxHeight:200,objectFit:"contain"},fallback:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RnG4W+FgYxN"})]}),r&&t.jsx("div",{style:{marginBottom:16},children:t.jsxs(M,{align:"start",style:{width:"100%",justifyContent:"space-between"},children:[t.jsx(Ye,{accept:"image/*",showUploadList:!1,customRequest:Qe,disabled:$,children:t.jsx(y,{loading:$,children:"上传图片文件"})}),t.jsxs(M,{children:[t.jsx(b,{placeholder:"通过图片 URL 更新",style:{width:320},value:C,onChange:e=>ee(e.target.value)}),t.jsx(y,{loading:je,onClick:qe,children:"更新图片"})]})]})}),!r&&t.jsx("div",{style:{marginBottom:16,padding:"12px 16px",background:"#f6f8fa",borderRadius:6,border:"1px solid #e1e4e8"},children:t.jsx("div",{style:{fontSize:14,color:"#586069",marginBottom:8},children:"💡 提示：新建轮播图时请直接填写图片URL，创建完成后可在编辑页面修改图片"})}),t.jsx(d.Item,{name:"categoryId",label:"分类",rules:[{required:!0}],children:t.jsx(Y,{options:Ce,placeholder:"选择分类"})}),t.jsx(d.Item,{name:"seriesId",label:"关联系列",hidden:j===!0,rules:j?[]:[{required:!0,message:"请选择关联的系列"}],children:t.jsx(Y,{showSearch:!0,allowClear:!0,placeholder:"搜索系列名称",filterOption:!1,options:se,loading:D,onDropdownVisibleChange:e=>{e&&se.length===0&&!D&&R({reset:!0})},onPopupScroll:e=>{const s=e.target,n=s&&s.scrollHeight-s.offsetHeight>0,a=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,l=s&&s.scrollTop>0;n&&a&&l&&Ue&&!D&&R({page:be+1})},onSearch:e=>{H.current&&window.clearTimeout(H.current),H.current=window.setTimeout(()=>{D||R({reset:!0,keyword:(e||"").trim()})},300)}})}),t.jsx(d.Item,{name:"linkUrl",label:j?"广告链接":"跳转链接(可选)",rules:j?[{required:!0,message:"请填写广告链接"},{type:"url",message:"请输入合法的 URL"}]:[],children:t.jsx(b,{placeholder:j?"https://example.com":"可选"})}),t.jsx(d.Item,{name:"weight",label:"权重",children:t.jsx(Ke,{style:{width:"100%"}})}),t.jsx(d.Item,{name:"startTime",label:"开始时间",children:t.jsx(ge,{showTime:!0,style:{width:"100%"}})}),t.jsx(d.Item,{name:"endTime",label:"结束时间",children:t.jsx(ge,{showTime:!0,style:{width:"100%"}})}),t.jsx(d.Item,{name:"description",label:"描述",children:t.jsx(b.TextArea,{rows:3})}),t.jsx(d.Item,{name:"isActive",label:"启用",valuePropName:"checked",initialValue:!0,children:t.jsx(N,{})})]})}),t.jsx(K,{title:"确认删除",open:Se,onOk:De,onCancel:Le,okText:"确认删除",cancelText:"取消",okType:"danger",children:t.jsxs("p",{children:["确定要删除轮播图「",T?.title,"」吗？此操作不可撤销。"]})}),t.jsx(K,{title:"确认修改",open:ve,onOk:Re,onCancel:Pe,okText:"确认修改",cancelText:"取消",children:t.jsxs("p",{children:["确定要修改轮播图「",E?.title,"」吗？"]})})]})}export{et as default};
