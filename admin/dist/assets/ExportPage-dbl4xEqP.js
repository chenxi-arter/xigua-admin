import{j as o,d as b}from"./index-Cg_-xLYc.js";import{r as C}from"./react-vendor-BZ8KDC-J.js";import{C as H,c as I}from"./admin-GjbIb_5T.js";import{m as J,a as m,i as Q,l as X,f as Z,B as v,u as tt,g as j,s as c}from"./antd-vendor-Did3y5v4.js";import{R as W}from"./DownloadOutlined-C1XqZ9Lr.js";import"./client-BbHh6MVO.js";import"./utils-vendor-NIGUFBhG.js";const{RangePicker:et}=X,{Title:at,Text:k}=Q;function ct(){const[u,F]=C.useState(null),[D,L]=C.useState([]),[$,E]=C.useState([]),[x,U]=C.useState([]),[S,w]=C.useState(!1),[Y,P]=C.useState("play"),[M,T]=C.useState(void 0),A=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"播放量",dataIndex:"playCount",key:"playCount",width:100,sorter:(t,e)=>t.playCount-e.playCount},{title:"完播率",dataIndex:"completionRate",key:"completionRate",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.completionRate-e.completionRate},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"点赞",dataIndex:"likeCount",key:"likeCount",width:80,sorter:(t,e)=>t.likeCount-e.likeCount},{title:"分享",dataIndex:"shareCount",key:"shareCount",width:80,sorter:(t,e)=>t.shareCount-e.shareCount},{title:"收藏",dataIndex:"favoriteCount",key:"favoriteCount",width:80,sorter:(t,e)=>t.favoriteCount-e.favoriteCount}],z=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"总新增",dataIndex:"newUsers",key:"newUsers",width:100,sorter:(t,e)=>t.newUsers-e.newUsers},{title:"次日留存",dataIndex:"nextDayRetention",key:"nextDayRetention",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.nextDayRetention-e.nextDayRetention},{title:"日活",dataIndex:"dau",key:"dau",width:100,sorter:(t,e)=>t.dau-e.dau},{title:"平均观影时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"新增来源",dataIndex:"newUserSource",key:"newUserSource",width:120}],g=C.useMemo(()=>{const t=new Map;return x.forEach(e=>{t.has(e.date)||t.set(e.date,[]),t.get(e.date).push(e)}),Array.from(t.entries()).map(([e,n])=>{const s=n.reduce((r,l)=>r+l.playCount,0),d=n.reduce((r,l)=>r+l.completionRate,0)/n.length,h=n.reduce((r,l)=>r+l.avgWatchDuration,0)/n.length,a=n.reduce((r,l)=>r+l.likeCount,0),y=n.reduce((r,l)=>r+l.dislikeCount,0),i=n.reduce((r,l)=>r+l.shareCount,0),p=n.reduce((r,l)=>r+l.favoriteCount,0),f=n.reduce((r,l)=>r+l.commentCount,0);return{date:e,seriesCount:n.length,series:n,totalPlayCount:s,avgCompletionRate:d,avgWatchDuration:h,totalLikeCount:a,totalDislikeCount:y,totalShareCount:i,totalFavoriteCount:p,totalCommentCount:f}}).sort((e,n)=>n.date.localeCompare(e.date))},[x]),B=[{title:"日期",dataIndex:"date",key:"date",width:120,fixed:"left"},{title:"系列数",dataIndex:"seriesCount",key:"seriesCount",width:80},{title:"总播放量",dataIndex:"totalPlayCount",key:"totalPlayCount",width:120,sorter:(t,e)=>t.totalPlayCount-e.totalPlayCount,render:t=>t.toLocaleString()},{title:"平均完播率",dataIndex:"avgCompletionRate",key:"avgCompletionRate",width:120,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.avgCompletionRate-e.avgCompletionRate},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=Math.floor(t%60);return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"总点赞",dataIndex:"totalLikeCount",key:"totalLikeCount",width:100,sorter:(t,e)=>t.totalLikeCount-e.totalLikeCount,render:t=>t.toLocaleString()},{title:"总踩",dataIndex:"totalDislikeCount",key:"totalDislikeCount",width:100,sorter:(t,e)=>t.totalDislikeCount-e.totalDislikeCount,render:t=>t.toLocaleString()},{title:"总分享",dataIndex:"totalShareCount",key:"totalShareCount",width:100,sorter:(t,e)=>t.totalShareCount-e.totalShareCount,render:t=>t.toLocaleString()},{title:"总收藏",dataIndex:"totalFavoriteCount",key:"totalFavoriteCount",width:100,sorter:(t,e)=>t.totalFavoriteCount-e.totalFavoriteCount,render:t=>t.toLocaleString()},{title:"总评论",dataIndex:"totalCommentCount",key:"totalCommentCount",width:100,sorter:(t,e)=>t.totalCommentCount-e.totalCommentCount,render:t=>t.toLocaleString()}],[_,O]=C.useState([]);C.useEffect(()=>{(async()=>{try{const e=await H.list();e&&Array.isArray(e)&&O(e)}catch(e){console.error("获取分类列表失败:",e)}})()},[]);const K=async()=>{if(!u){c.warning("请选择日期范围");return}const[t,e]=u,n=t.format("YYYY-MM-DD"),s=e.format("YYYY-MM-DD");w(!0);try{const[d,h,a]=await Promise.all([I.getPlayStats({startDate:n,endDate:s}),I.getUserStats({startDate:n,endDate:s}),I.getSeriesDetails({startDate:n,endDate:s,categoryId:M})]);d.code===200?L(d.data):c.error(`获取播放数据失败: ${d.message}`),h.code===200?E(h.data):c.error(`获取用户数据失败: ${h.message}`),a.code===200?U(a.data):c.error(`获取系列数据失败: ${a.message}`),c.success("数据获取成功")}catch(d){c.error("获取数据失败，请检查网络连接"),console.error("Export data fetch error:",d)}finally{w(!1)}},R=(t,e,n)=>{if(t.length===0){c.warning("没有数据可导出");return}let s="";n?(s=`日期,播放量,完播率,平均观看时长,点赞,分享,收藏
`,t.forEach(i=>{const p=Math.floor(i.avgWatchDuration/60),f=i.avgWatchDuration%60;s+=`${i.date},${i.playCount},${(i.completionRate*100).toFixed(2)}%,${p}分${f}秒,${i.likeCount},${i.shareCount},${i.favoriteCount}
`})):(s=`日期,总新增,次日留存,日活,平均观影时长,新增来源
`,t.forEach(i=>{const p=Math.floor(i.avgWatchDuration/60),f=i.avgWatchDuration%60;s+=`${i.date},${i.newUsers},${(i.nextDayRetention*100).toFixed(2)}%,${i.dau},${p}分${f}秒,${i.newUserSource}
`}));const d="\uFEFF",h=new Blob([d+s],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),y=URL.createObjectURL(h);a.setAttribute("href",y),a.setAttribute("download",`${e}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),c.success("导出成功")},N=()=>{const t=`播放数据统计_${u?.[0].format("YYYYMMDD")}_${u?.[1].format("YYYYMMDD")}`;R(D,t,!0)},V=()=>{const t=`用户数据统计_${u?.[0].format("YYYYMMDD")}_${u?.[1].format("YYYYMMDD")}`;R($,t,!1)},q=()=>{if(g.length===0){c.warning("没有数据可导出");return}let t=`日期,系列数,总播放量,平均完播率,平均观看时长,总点赞,总踩,总分享,总收藏,总评论
`;g.forEach(a=>{const y=Math.floor(a.avgWatchDuration/60),i=Math.floor(a.avgWatchDuration%60);t+=`${a.date},${a.seriesCount},${a.totalPlayCount},${(a.avgCompletionRate*100).toFixed(2)}%,${y}分${i}秒,${a.totalLikeCount},${a.totalDislikeCount},${a.totalShareCount},${a.totalFavoriteCount},${a.totalCommentCount}
`});const e="\uFEFF",n=new Blob([e+t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),d=URL.createObjectURL(n),h=`系列数据汇总_${u?.[0].format("YYYYMMDD")}_${u?.[1].format("YYYYMMDD")}`;s.setAttribute("href",d),s.setAttribute("download",`${h}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("导出成功")},G=()=>{if(x.length===0){c.warning("没有数据可导出");return}let t=`日期,系列名称,分类,剧集数,播放量,完播率,平均观看时长,点赞,踩,分享,收藏,评论
`;x.forEach(a=>{const y=Math.floor(a.avgWatchDuration/60),i=Math.floor(a.avgWatchDuration%60);t+=`${a.date},${a.seriesTitle},${a.categoryName},${a.episodeCount},${a.playCount},${(a.completionRate*100).toFixed(2)}%,${y}分${i}秒,${a.likeCount},${a.dislikeCount},${a.shareCount},${a.favoriteCount},${a.commentCount}
`});const e="\uFEFF",n=new Blob([e+t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),d=URL.createObjectURL(n),h=`系列明细数据_${u?.[0].format("YYYYMMDD")}_${u?.[1].format("YYYYMMDD")}`;s.setAttribute("href",d),s.setAttribute("download",`${h}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),c.success("导出成功")};return o.jsx("div",{className:"page",children:o.jsx(J,{children:o.jsxs(m,{direction:"vertical",size:"large",style:{width:"100%"},children:[o.jsxs("div",{children:[o.jsxs(at,{level:3,children:[o.jsx(b,{})," 运营数据导出"]}),o.jsx(k,{type:"secondary",children:"选择日期范围，查看并导出播放数据和用户数据统计"})]}),o.jsxs(m,{size:"middle",wrap:!0,children:[o.jsx(et,{value:u,onChange:t=>F(t),format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],style:{width:300}}),Y==="series"&&o.jsx(Z,{placeholder:"选择分类（可选）",allowClear:!0,value:M,onChange:T,style:{width:200},options:[{label:"全部分类",value:void 0},..._.map(t=>({label:t.name,value:t.id}))]}),o.jsx(v,{type:"primary",icon:o.jsx(W,{}),onClick:K,loading:S,children:"获取数据"})]}),o.jsx(tt,{activeKey:Y,onChange:P,items:[{key:"play",label:"播放数据统计",children:o.jsxs(m,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(k,{strong:!0,children:["共 ",D.length," 条记录"]}),o.jsx(v,{type:"primary",icon:o.jsx(b,{}),onClick:N,disabled:D.length===0,children:"导出为 CSV"})]}),o.jsx(j,{columns:A,dataSource:D,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:S,scroll:{x:800}})]})},{key:"user",label:"用户数据统计",children:o.jsxs(m,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(k,{strong:!0,children:["共 ",$.length," 条记录"]}),o.jsx(v,{type:"primary",icon:o.jsx(b,{}),onClick:V,disabled:$.length===0,children:"导出为 CSV"})]}),o.jsx(j,{columns:z,dataSource:$,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:S,scroll:{x:800}})]})},{key:"series",label:"系列明细数据",children:o.jsxs(m,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(m,{children:[o.jsxs(k,{strong:!0,children:["共 ",g.length," 天"]}),o.jsxs(k,{type:"secondary",children:["(",x.length," 条系列记录)"]})]}),o.jsxs(m,{children:[o.jsx(v,{type:"primary",icon:o.jsx(W,{}),onClick:q,disabled:g.length===0,children:"导出为 CSV（按日期汇总）"}),o.jsx(v,{icon:o.jsx(b,{}),onClick:G,disabled:x.length===0,children:"导出明细（含所有系列）"})]})]}),o.jsx(j,{columns:B,dataSource:g,rowKey:"date",expandable:{expandedRowRender:t=>o.jsx(j,{columns:[{title:"系列名称",dataIndex:"seriesTitle",key:"seriesTitle",width:200},{title:"分类",dataIndex:"categoryName",key:"categoryName",width:100},{title:"剧集数",dataIndex:"episodeCount",key:"episodeCount",width:80},{title:"播放量",dataIndex:"playCount",key:"playCount",width:100,render:e=>e.toLocaleString()},{title:"完播率",dataIndex:"completionRate",key:"completionRate",width:100,render:e=>`${(e*100).toFixed(2)}%`},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:e=>{const n=Math.floor(e/60),s=Math.floor(e%60);return`${n}分${s}秒`}},{title:"点赞",dataIndex:"likeCount",key:"likeCount",width:80},{title:"踩",dataIndex:"dislikeCount",key:"dislikeCount",width:80},{title:"分享",dataIndex:"shareCount",key:"shareCount",width:80},{title:"收藏",dataIndex:"favoriteCount",key:"favoriteCount",width:80},{title:"评论",dataIndex:"commentCount",key:"commentCount",width:80}],dataSource:t.series,rowKey:e=>`${e.seriesId}`,pagination:!1,size:"small"}),rowExpandable:t=>t.series.length>0},pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 天`},loading:S,scroll:{x:1200}})]})}]})]})})})}export{ct as default};
