import{j as t}from"./index-D5f2_Mxj.js";import{r as l}from"./react-vendor-BZ8KDC-J.js";import{C as Ne,S as Ke,a as ge,B as f}from"./admin--tzWvWSE.js";import{F as u,d as me,s as c,k as pe,B as I,o as J,a as C,f as W,g as Ye,b as _,I as T,U as $e,p as Je,l as he}from"./antd-vendor-aNvYRewR.js";import{f as fe}from"./format-0Cj3JWJt.js";import"./client-BbHh6MVO.js";import"./utils-vendor-NIGUFBhG.js";function at(){const E=e=>!!e&&/^(https?:)?\/\//i.test(e),[ye,X]=l.useState(!1),[xe,Ae]=l.useState([]),[we,je]=l.useState(0),[v,Z]=l.useState(1),[x,Ie]=l.useState(10),[ve,b]=l.useState(!1),[d,ee]=l.useState(null),[h]=u.useForm(),U=u.useWatch("isAd",h),[z,te]=l.useState(!1),[Q,q]=l.useState(0),[Se,se]=l.useState(!1),[R,ae]=l.useState(""),[be,H]=l.useState(!1),[L,G]=l.useState(null),[Ue,V]=l.useState(!1),[P,N]=l.useState(null),[ie,y]=l.useState(null),[le,k]=l.useState([]),[B,ke]=l.useState(void 0),[D,ne]=l.useState(!1),[Ce,re]=l.useState(1),[Te,oe]=l.useState(!0),K=l.useRef(void 0),Y=l.useRef(""),$=l.useRef(1),[Ee,Re]=l.useState([]),[de,Le]=l.useState({}),Pe=l.useCallback(async()=>{try{const e=await Ne.list(1,200),s=(e.items||[]).map(i=>({value:i.id,label:i.name||String(i.categoryId||i.id)}));Re(s);const n={};(e.items||[]).forEach(i=>{const a=i.name||String(i.categoryId||i.id);n[String(i.id)]=a,i.categoryId!==void 0&&i.categoryId!==null&&(n[String(i.categoryId)]=a)}),Le(n)}catch{}},[]),M=50,F=l.useCallback(async e=>{const s=e?.keyword!==void 0?e.keyword:Y.current,n=e?.reset?1:e?.page||$.current;ne(!0);try{if(s&&s.trim()){const i=await Ke.fuzzy({keyword:s.trim(),page:n,size:M}),a=i?.data||i,S=(a?.list||a?.items||[]).map(r=>({value:r.id,label:`#${r.id} ${r.title||""}`}));e?.reset?k(S):k(r=>{const A=new Map;return r.forEach(j=>A.set(j.value,j.label)),S.forEach(j=>A.set(j.value,j.label)),Array.from(A.entries()).map(([j,Ve])=>({value:j,label:Ve}))});const m=a?.page||n;Y.current=s||"",re(m),$.current=m;const O=a?.total??0,p=a?.size??M;oe(m*p<O||a?.hasMore===!0)}else{const i=await ge.list(n,M),a=(i.items||[]).map(p=>({value:p.id,label:`#${p.id} ${p.title||""}`}));e?.reset?k(a):k(p=>{const o=new Map;return p.forEach(r=>o.set(r.value,r.label)),a.forEach(r=>o.set(r.value,r.label)),Array.from(o.entries()).map(([r,A])=>({value:r,label:A}))});const w=i.page||n;Y.current="",re(w),$.current=w;const S=i.total??0,m=i.size??M;oe(w*m<S)}}catch{}finally{ne(!1)}},[]),g=l.useCallback(async(e=v,s=x,n=B)=>{X(!0);try{const i=await f.list(e,s);let a=i.items;n!==void 0&&(a=i.items.filter(w=>w.isAd===n)),Ae(a),je(n!==void 0?a.length:i.total),Z(e),Ie(s)}finally{X(!1)}},[v,x,B]);l.useEffect(()=>{g(1,x),F({reset:!0}),Pe()},[]);const ce=l.useCallback(e=>{ee(e),h.setFieldsValue({...e,startTime:e.startTime?me(e.startTime):null,endTime:e.endTime?me(e.endTime):null}),e.imageUrl&&E(e.imageUrl)&&y(e.imageUrl),e.seriesId&&(async()=>{try{const s=await ge.get(e.seriesId),n={value:s.id,label:`#${s.id} ${s.title||""}`};k(i=>i.find(a=>a.value===n.value)?i:[n,...i])}catch{}})(),b(!0)},[h]),ue=l.useCallback(e=>{G(e),H(!0)},[]),Be=l.useCallback(async()=>{if(L)try{await f.remove(L.id),c.success("å·²åˆ é™¤"),g()}catch{c.error("åˆ é™¤å¤±è´¥")}finally{H(!1),G(null)}},[L,g]),De=l.useCallback(()=>{H(!1),G(null)},[]),Me=l.useCallback(async()=>{if(!(!d||!P))try{await f.update(d.id,P),c.success("å·²æ›´æ–°"),b(!1),y(null),g()}catch{c.error("ä¿®æ”¹å¤±è´¥")}finally{V(!1),N(null)}},[d,P,g]),Fe=l.useCallback(()=>{V(!1),N(null)},[]),Oe=l.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"æ ‡é¢˜",dataIndex:"title",width:240,render:e=>t.jsx("span",{className:"text-ellipsis",style:{display:"inline-block",maxWidth:240},children:e})},{title:"å›¾ç‰‡",width:260,render:(e,s)=>E(s.imageUrl)?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx(pe,{src:s.imageUrl,alt:"banner",width:80,height:48,style:{objectFit:"cover",borderRadius:4}}),s.linkUrl&&t.jsx(I,{type:"link",onClick:()=>Ge(s),children:"æ‰“å¼€"})]}):"-"},{title:"åˆ†ç±»",dataIndex:"categoryId",width:140,render:(e,s)=>de[String(s.categoryId)]||s.categoryId},{title:"ç³»åˆ—ID",dataIndex:"seriesId",width:100},{title:"æƒé‡",dataIndex:"weight",width:120,render:e=>e??"-"},{title:"ç±»å‹",dataIndex:"isAd",render:e=>e?"å¹¿å‘Š":"å…³è”å‰§é›†",width:80},{title:"å¯ç”¨",dataIndex:"isActive",width:100,render:(e,s)=>t.jsx(J,{checked:!!e,onChange:async n=>{try{await f.updateStatus(s.id,n),c.success(n?"å·²å¯ç”¨":"å·²ç¦ç”¨"),g()}catch{c.error("æ›´æ–°çŠ¶æ€å¤±è´¥")}}})},{title:"æ›å…‰",dataIndex:"impressions",width:100},{title:"ç‚¹å‡»",dataIndex:"clicks",width:100},{title:"å¼€å§‹æ—¶é—´",dataIndex:"startTime",width:180,render:e=>fe(e)},{title:"ç»“æŸæ—¶é—´",dataIndex:"endTime",width:180,render:e=>fe(e)},{title:"æ“ä½œ",width:220,render:(e,s)=>t.jsxs(C,{children:[t.jsx(I,{onClick:()=>ce(s),type:"link",children:"ç¼–è¾‘"}),t.jsx(I,{onClick:()=>ue(s),danger:!0,type:"link",children:"åˆ é™¤"})]})}],[ce,ue,de,g]),ze=()=>{ee(null),h.resetFields(),y(null),b(!0)},Qe=async()=>{const e=await h.validateFields(),s=i=>i?new Date(i.valueOf()).toISOString():void 0,n={...e,startTime:s(e.startTime),endTime:s(e.endTime)};if(e.isAd?delete n.seriesId:delete n.linkUrl,d)N(n),V(!0);else try{const i={title:e.title,imageUrl:e.imageUrl,categoryId:e.categoryId,weight:e.weight,isActive:e.isActive,isAd:e.isAd,startTime:s(e.startTime),endTime:s(e.endTime),description:e.description,linkUrl:e.isAd?e.linkUrl:void 0,seriesId:e.isAd?void 0:e.seriesId};await f.create(i),c.success("å·²åˆ›å»º"),b(!1),y(null),g()}catch{c.error("åˆ›å»ºå¤±è´¥")}},qe=async e=>{const{file:s,onSuccess:n,onError:i}=e;if(!d){c.warning("æ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡"),i?.(new Error("æ–°å»ºæ¨¡å¼ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ "));return}try{te(!0),q(0);const a=s;if(!["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(a.type))throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼  JPEGã€PNGã€WebP æˆ– GIF å›¾ç‰‡");const S=10*1024*1024;if(a.size>S)throw new Error("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB");console.log("[ä¸Šä¼ ] å¼€å§‹è·å–é¢„ç­¾å URL",{bannerId:d.id,filename:a.name,contentType:a.type,fileSize:a.size});const m=await f.getPresignedUploadUrl(d.id,{filename:a.name,contentType:a.type||"image/jpeg"});console.log("[ä¸Šä¼ ] è·å–é¢„ç­¾å URL æˆåŠŸ",m),await new Promise((O,p)=>{const o=new XMLHttpRequest;o.upload.addEventListener("progress",r=>{if(r.lengthComputable){const A=Math.round(r.loaded/r.total*100);q(A),console.log("[ä¸Šä¼ ] è¿›åº¦:",A+"%")}}),o.addEventListener("load",()=>{if(console.log("[ä¸Šä¼ ] è¯·æ±‚å®Œæˆ",{status:o.status,statusText:o.statusText,responseText:o.responseText}),o.status===200||o.status===204)console.log("[ä¸Šä¼ ] ä¸Šä¼ åˆ° R2 æˆåŠŸ"),O();else{const r=`ä¸Šä¼ å¤±è´¥ (çŠ¶æ€ç : ${o.status})${o.responseText?": "+o.responseText:""}`;console.error("[ä¸Šä¼ ] å¤±è´¥:",r),p(new Error(r))}}),o.addEventListener("error",r=>{console.error("[ä¸Šä¼ ] ç½‘ç»œé”™è¯¯:",r),console.error("[ä¸Šä¼ ] å¯èƒ½çš„åŸå› : CORS é…ç½®é—®é¢˜ã€ç½‘ç»œä¸­æ–­ã€æˆ– R2 è®¿é—®æƒé™é—®é¢˜"),p(new Error("ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯æˆ– CORS é…ç½®é—®é¢˜"))}),o.addEventListener("abort",()=>{console.warn("[ä¸Šä¼ ] ä¸Šä¼ å·²å–æ¶ˆ"),p(new Error("ä¸Šä¼ å·²å–æ¶ˆ"))}),console.log("[ä¸Šä¼ ] å¼€å§‹ä¸Šä¼ åˆ° R2",{url:m.uploadUrl.substring(0,100)+"...",contentType:a.type||"image/jpeg"}),o.open("PUT",m.uploadUrl),o.setRequestHeader("Content-Type",a.type||"image/jpeg"),o.send(a)}),await f.notifyUploadComplete(d.id,{fileKey:m.fileKey,publicUrl:m.publicUrl,fileSize:a.size}),h.setFieldsValue({imageUrl:m.publicUrl}),y(m.publicUrl),c.success("å›¾ç‰‡å·²ä¸Šä¼ åˆ° R2 å­˜å‚¨"),g(v,x),n?.({})}catch(a){i?.(a instanceof Error?a:new Error(String(a))),c.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${a instanceof Error?a.message:String(a)}`)}finally{te(!1),q(0)}},He=async()=>{if(!d){c.warning("æ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡");return}if(!R||!/^https?:\/\//i.test(R)){c.warning("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡ URL");return}try{se(!0),await f.imageFromUrl(d.id,R.trim());const e=await f.get(d.id);h.setFieldsValue({imageUrl:e.imageUrl}),y(e.imageUrl),c.success("å·²é€šè¿‡ URL æ›´æ–°å›¾ç‰‡"),ae(""),g(v,x)}catch{c.error("é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡å¤±è´¥")}finally{se(!1)}},Ge=e=>{e.linkUrl&&(window.open(e.linkUrl,"_blank"),f.click(e.id))};return t.jsxs("div",{className:"page",children:[t.jsxs(C,{className:"page-toolbar",children:[t.jsx(I,{type:"primary",onClick:ze,children:"æ–°å»ºè½®æ’­å›¾"}),t.jsx(W,{placeholder:"ç­›é€‰ç±»å‹",style:{width:120},allowClear:!0,value:B,onChange:e=>{ke(e),Z(1),g(1,x,e)},options:[{value:!0,label:"å¹¿å‘Š"},{value:!1,label:"å…³è”å‰§é›†"}]}),t.jsx(I,{onClick:()=>g(v,x,B),children:"åˆ·æ–°"})]}),t.jsx(Ye,{rowKey:"id",loading:ye,dataSource:xe,columns:Oe,scroll:{x:1100,y:"calc(100vh - 300px)"},tableLayout:"fixed",pagination:{current:v,pageSize:x,total:we,position:["bottomCenter"],onChange:(e,s)=>g(e,s)}}),t.jsx(_,{title:d?"ç¼–è¾‘è½®æ’­å›¾":"æ–°å»ºè½®æ’­å›¾",open:ve,onCancel:()=>{b(!1),y(null)},onOk:Qe,okText:"ä¿å­˜",width:720,children:t.jsxs(u,{form:h,layout:"vertical",children:[t.jsx(u.Item,{name:"title",label:"æ ‡é¢˜",rules:[{required:!0}],children:t.jsx(T,{})}),t.jsx(u.Item,{name:"isAd",label:"å¹¿å‘Š/å…³è”å‰§é›†",valuePropName:"checked",initialValue:!1,children:t.jsx(J,{checkedChildren:"å¹¿å‘Š",unCheckedChildren:"å…³è”å‰§é›†",onChange:e=>{e?h.setFieldsValue({seriesId:void 0}):h.setFieldsValue({linkUrl:void 0})}})}),t.jsx(u.Item,{name:"imageUrl",label:"å›¾ç‰‡URL",rules:[{required:!0}],children:t.jsx(T,{placeholder:"å¯ç›´æ¥å¡«å†™å›¾ç‰‡ URLï¼Œæˆ–åœ¨ä¸‹æ–¹é€‰æ‹©å›¾ç‰‡æ–‡ä»¶",onChange:e=>{const s=e.target.value;s&&E(s)?y(s):s||y(null)}})}),(ie||d?.imageUrl&&E(d.imageUrl))&&t.jsxs("div",{style:{marginBottom:16,textAlign:"center"},children:[t.jsx("div",{style:{fontSize:14,color:"#666",marginBottom:8},children:"å›¾ç‰‡é¢„è§ˆï¼š"}),t.jsx(pe,{src:ie||d?.imageUrl,alt:"banner preview",style:{maxWidth:"100%",maxHeight:200,objectFit:"contain"},fallback:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RnG4W+FgYxN"})]}),d&&t.jsx("div",{style:{marginBottom:16},children:t.jsxs(C,{direction:"vertical",style:{width:"100%"},children:[t.jsxs(C,{align:"start",style:{width:"100%",justifyContent:"space-between"},children:[t.jsx($e,{accept:"image/jpeg,image/jpg,image/png,image/webp,image/gif",showUploadList:!1,customRequest:qe,disabled:z,children:t.jsx(I,{loading:z,children:"ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶"})}),t.jsxs(C,{children:[t.jsx(T,{placeholder:"é€šè¿‡å›¾ç‰‡ URL æ›´æ–°",style:{width:320},value:R,onChange:e=>ae(e.target.value)}),t.jsx(I,{loading:Se,onClick:He,children:"æ›´æ–°å›¾ç‰‡"})]})]}),z&&Q>0&&t.jsx("div",{style:{width:"100%"},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{flex:1,height:8,background:"#f0f0f0",borderRadius:4,overflow:"hidden"},children:t.jsx("div",{style:{height:"100%",background:"#1890ff",width:`${Q}%`,transition:"width 0.3s ease"}})}),t.jsxs("span",{style:{fontSize:12,color:"#666",minWidth:40},children:[Q,"%"]})]})})]})}),!d&&t.jsx("div",{style:{marginBottom:16,padding:"12px 16px",background:"#f6f8fa",borderRadius:6,border:"1px solid #e1e4e8"},children:t.jsx("div",{style:{fontSize:14,color:"#586069",marginBottom:8},children:"ğŸ’¡ æç¤ºï¼šæ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡"})}),t.jsx(u.Item,{name:"categoryId",label:"åˆ†ç±»",rules:[{required:!0}],children:t.jsx(W,{options:Ee,placeholder:"é€‰æ‹©åˆ†ç±»"})}),t.jsx(u.Item,{name:"seriesId",label:"å…³è”ç³»åˆ—",hidden:U===!0,rules:U?[]:[{required:!0,message:"è¯·é€‰æ‹©å…³è”çš„ç³»åˆ—"}],children:t.jsx(W,{showSearch:!0,allowClear:!0,placeholder:"æœç´¢ç³»åˆ—åç§°",filterOption:!1,options:le,loading:D,onDropdownVisibleChange:e=>{e&&le.length===0&&!D&&F({reset:!0})},onPopupScroll:e=>{const s=e.target,n=s&&s.scrollHeight-s.offsetHeight>0,i=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,a=s&&s.scrollTop>0;n&&i&&a&&Te&&!D&&F({page:Ce+1})},onSearch:e=>{K.current&&window.clearTimeout(K.current),K.current=window.setTimeout(()=>{D||F({reset:!0,keyword:(e||"").trim()})},300)}})}),t.jsx(u.Item,{name:"linkUrl",label:U?"å¹¿å‘Šé“¾æ¥":"è·³è½¬é“¾æ¥(å¯é€‰)",rules:U?[{required:!0,message:"è¯·å¡«å†™å¹¿å‘Šé“¾æ¥"},{type:"url",message:"è¯·è¾“å…¥åˆæ³•çš„ URL"}]:[],children:t.jsx(T,{placeholder:U?"https://example.com":"å¯é€‰"})}),t.jsx(u.Item,{name:"weight",label:"æƒé‡",children:t.jsx(Je,{style:{width:"100%"}})}),t.jsx(u.Item,{name:"startTime",label:"å¼€å§‹æ—¶é—´",children:t.jsx(he,{showTime:!0,style:{width:"100%"}})}),t.jsx(u.Item,{name:"endTime",label:"ç»“æŸæ—¶é—´",children:t.jsx(he,{showTime:!0,style:{width:"100%"}})}),t.jsx(u.Item,{name:"description",label:"æè¿°",children:t.jsx(T.TextArea,{rows:3})}),t.jsx(u.Item,{name:"isActive",label:"å¯ç”¨",valuePropName:"checked",initialValue:!0,children:t.jsx(J,{})})]})}),t.jsx(_,{title:"ç¡®è®¤åˆ é™¤",open:be,onOk:Be,onCancel:De,okText:"ç¡®è®¤åˆ é™¤",cancelText:"å–æ¶ˆ",okType:"danger",children:t.jsxs("p",{children:["ç¡®å®šè¦åˆ é™¤è½®æ’­å›¾ã€Œ",L?.title,"ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"]})}),t.jsx(_,{title:"ç¡®è®¤ä¿®æ”¹",open:Ue,onOk:Me,onCancel:Fe,okText:"ç¡®è®¤ä¿®æ”¹",cancelText:"å–æ¶ˆ",children:t.jsxs("p",{children:["ç¡®å®šè¦ä¿®æ”¹è½®æ’­å›¾ã€Œ",P?.title,"ã€å—ï¼Ÿ"]})})]})}export{at as default};
