import{j as t}from"./index-BqQ0KmuN.js";import{j as Me,r as s}from"./react-vendor-BZ8KDC-J.js";import{C as Le,S as Oe,a as g,E as Re}from"./admin-1nbZk7RE.js";import{f as X}from"./format-0Cj3JWJt.js";import{F as m,s as i,T as Be,a as Z,B as d,b as Fe,I as k,d as ee,e as ze,f as S,g as Qe,h as Ue}from"./antd-vendor-CCOR70di.js";import{R as Pe}from"./EyeOutlined-RgGrQzxa.js";import{R as qe}from"./DownloadOutlined-BpHZrK3i.js";import"./utils-vendor-NIGUFBhG.js";function We(){const P=Me(),[te,q]=s.useState(!1),[se,v]=s.useState([]),[ae,I]=s.useState(0),[G,E]=s.useState(1),[C,D]=s.useState(10),[oe,y]=s.useState(!1),[A,V]=s.useState(null),[ne,T]=s.useState(!1),[j,M]=s.useState(null),[le,L]=s.useState(!1),[b,O]=s.useState(null),[f]=m.useForm(),[ie,R]=s.useState(!1),[r,re]=s.useState(null),[h,ce]=s.useState("active"),[de,Y]=s.useState(!1),[B,ue]=s.useState(null),[pe,H]=s.useState(!1),[he,ge]=s.useState([]),[me,ye]=s.useState(0),[F,Ae]=s.useState(1),[x,fe]=s.useState(10),[w,xe]=s.useState(""),z=s.useRef(void 0),[K,we]=s.useState({}),[Ce,je]=s.useState([]),N=s.useCallback(async()=>{try{const e=await Le.list(1,200),o=(e.items||[]).map(a=>({value:a.id,label:a.name||String(a.categoryId||a.id)}));je(o);const n={};(e.items||[]).forEach(a=>{const l=a.name||String(a.categoryId||a.id);n[String(a.id)]=l,a.categoryId!==void 0&&a.categoryId!==null&&(n[String(a.categoryId)]=l)}),we(n)}catch{}},[]),c=s.useCallback(async(e=G,o=C,n=w)=>{q(!0);try{if(n&&n.trim()){const l=await Oe.fuzzy({keyword:n.trim(),page:e,size:o}),u=typeof l=="object"&&l&&"data"in l?l.data:l,p=u?.list||u?.items||[];v(p),I(u?.total||0),E(u?.page||e),D(u?.size||o)}else if(h==="deleted"){const a=await g.listDeleted(e,o);v(a.items||[]),I(a.total||0),E(a.page||e),D(a.size||o)}else{const a=await g.list(e,o);v(a.items),I(a.total),E(a.page),D(a.size)}}finally{q(!1)}},[w,h]);s.useEffect(()=>{c(1,C,w)},[c,w,h]),s.useEffect(()=>{N()},[N]);const Q=s.useCallback(async(e,o=F,n=x)=>{H(!0);try{const a=await Re.list(o,n,{seriesId:e}),l=a.items||[];ge(l),ye(a.total),Ae(a.page),fe(a.size)}finally{H(!1)}},[F,x]),be=()=>{V(null),f.resetFields(),y(!0)},$=s.useCallback(e=>{ue(e),Y(!0),Q(e.id,1,x)},[Q,x]),J=s.useCallback(e=>{P(`/episodes?seriesId=${e.id}`)},[P]),W=s.useCallback(e=>{V(e),f.setFieldsValue(e),y(!0)},[f]),_=s.useCallback(e=>{M(e),T(!0)},[]),ke=s.useCallback(async()=>{if(j)try{await g.remove(j.id),i.success("已删除"),c()}catch{i.error("删除失败")}finally{T(!1),M(null)}},[j,c]),Se=s.useCallback(()=>{T(!1),M(null)},[]),ve=s.useCallback(async()=>{if(!(!A||!b))try{await g.update(A.id,b),i.success("已更新"),y(!1),c()}catch{i.error("修改失败")}finally{L(!1),O(null)}},[A,b,c]),Ie=s.useCallback(()=>{L(!1),O(null)},[]),U=s.useCallback(e=>{e.coverUrl?(re({url:e.coverUrl,title:e.title}),R(!0)):i.warning("该系列暂无封面")},[]),Ee=s.useCallback(async(e,o)=>{try{i.loading("正在下载封面...",0);const n=o.replace(/[<>:"/\\|?*]/g,"_");try{const a=await fetch(e,{mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const l=await a.blob();if(l.size===0)throw new Error("下载的文件为空");const u=window.URL.createObjectURL(l),p=document.createElement("a");p.href=u,p.download=n,p.style.display="none",document.body.appendChild(p),p.click(),setTimeout(()=>{document.body.removeChild(p),window.URL.revokeObjectURL(u)},100),i.destroy(),i.success(`封面已保存为: ${n}`);return}catch(a){console.warn("Fetch方法失败，尝试备用方法:",a);const l=document.createElement("a");l.href=e,l.download=n,l.target="_blank",l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l),i.destroy(),i.success("已打开下载链接，请手动保存")}}catch(n){i.destroy(),console.error("下载封面失败:",n),i.error(`保存失败: ${n instanceof Error?n.message:"未知错误"}`)}},[]),De=s.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"标题",dataIndex:"title",width:200},{title:"描述",dataIndex:"description",width:300,ellipsis:{showTitle:!1},render:e=>t.jsx(Be,{placement:"topLeft",title:e||"无描述",children:t.jsx("span",{style:{cursor:"pointer"},children:e||t.jsx("span",{style:{color:"#ccc"},children:"无描述"})})})},{title:"封面",dataIndex:"coverUrl",width:100,render:(e,o)=>e?t.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[t.jsx("img",{src:e,alt:"cover",style:{width:56,height:56,objectFit:"cover",borderRadius:6,cursor:"pointer",transition:"opacity 0.2s"},onClick:()=>U(o),onMouseEnter:n=>{n.currentTarget.style.opacity="0.8"},onMouseLeave:n=>{n.currentTarget.style.opacity="1"}}),t.jsx("div",{style:{position:"absolute",top:2,right:2,background:"rgba(0,0,0,0.6)",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>U(o),children:t.jsx(Pe,{style:{color:"white",fontSize:10}})})]}):"-"},{title:"分类",dataIndex:"categoryId",width:120,render:e=>e==null?t.jsx("span",{style:{color:"#999"},children:"未分类"}):K[String(e)]||`ID:${e}`},{title:"创建时间",dataIndex:"createdAt",width:150,render:e=>X(e)},{title:"更新时间",dataIndex:"updatedAt",width:150,render:e=>X(e)},{title:"操作",width:420,render:(e,o)=>t.jsx(Z,{children:h==="deleted"?t.jsx(d,{type:"link",onClick:async()=>{try{await g.restore(o.id),i.success("已恢复"),c()}catch{i.error("恢复失败")}},children:"恢复"}):t.jsxs(t.Fragment,{children:[t.jsx(d,{onClick:()=>W(o),type:"link",children:"编辑"}),t.jsx(d,{onClick:()=>_(o),danger:!0,type:"link",children:"删除"}),t.jsx(d,{type:"link",onClick:()=>$(o),children:"查看剧集"}),t.jsx(d,{type:"link",onClick:()=>J(o),children:"管理剧集"})]})})}],[_,W,J,$,U,h,c,K]),Te=async()=>{const e=await f.validateFields();if(A)O(e),L(!0);else try{await g.create(e),i.success("已创建"),y(!1),c()}catch{i.error("创建失败")}};return t.jsxs("div",{className:"page",children:[t.jsxs(Z,{className:"page-toolbar",children:[t.jsx(d,{type:"primary",onClick:be,children:"新建系列"}),t.jsx(Fe,{options:[{label:"正常",value:"active"},{label:"回收站",value:"deleted"}],value:h,onChange:e=>ce(e)}),t.jsx(k,{placeholder:"搜索系列（标题关键字）",style:{width:280},allowClear:!0,onChange:e=>{const o=e.target.value||"";xe(o),z.current&&window.clearTimeout(z.current),z.current=window.setTimeout(()=>{c(1,C,o)},300)}}),t.jsx(d,{onClick:()=>c(),children:"刷新"})]}),t.jsx(ee,{rowKey:"id",loading:te,dataSource:se,columns:De,scroll:{x:1400},pagination:{current:G,pageSize:C,total:ae,position:["bottomCenter"],onChange:(e,o)=>c(e,o,w)}}),t.jsx(ze,{title:B?`系列「${B.title}」的剧集`:"剧集",open:de,onClose:()=>Y(!1),width:720,children:t.jsx(ee,{rowKey:"id",loading:pe,dataSource:he,columns:[{title:"ID",dataIndex:"id",width:100},{title:"集数",dataIndex:"episodeNumber",width:80},{title:"标题",dataIndex:"title"},{title:"时长(秒)",dataIndex:"duration",width:100},{title:"状态",dataIndex:"status",width:100}],pagination:{current:F,pageSize:x,total:me,position:["bottomCenter"],onChange:(e,o)=>{Q(B.id,e,o)}}})}),t.jsx(S,{title:A?"编辑系列":"新建系列",open:oe,onCancel:()=>y(!1),onOk:Te,okText:"保存",width:720,children:t.jsxs(m,{form:f,layout:"vertical",children:[t.jsx(m.Item,{name:"title",label:"标题",rules:[{required:!0}],children:t.jsx(k,{})}),t.jsx(m.Item,{name:"description",label:"描述",children:t.jsx(k.TextArea,{rows:3})}),t.jsx(m.Item,{name:"coverUrl",label:"封面地址",children:t.jsx(k,{})}),t.jsx(m.Item,{name:"categoryId",label:"分类",rules:[{required:!0,message:"请选择分类"}],children:t.jsx(Qe,{placeholder:"请选择分类",allowClear:!0,options:Ce,showSearch:!0,filterOption:(e,o)=>(o?.label??"").toLowerCase().includes(e.toLowerCase())})})]})}),t.jsx(S,{title:"确认删除",open:ne,onOk:ke,onCancel:Se,okText:"确认删除",cancelText:"取消",okType:"danger",children:t.jsxs("p",{children:["确定要删除系列「",j?.title,"」吗？此操作不可撤销。"]})}),t.jsx(S,{title:"确认修改",open:le,onOk:ve,onCancel:Ie,okText:"确认修改",cancelText:"取消",children:t.jsxs("p",{children:["确定要修改系列「",b?.title,"」吗？"]})}),t.jsx(S,{title:`封面预览 - ${r?.title}`,open:ie,onCancel:()=>R(!1),footer:[t.jsx(d,{onClick:()=>R(!1),children:"关闭"},"close"),t.jsx(d,{onClick:()=>{r&&navigator.clipboard.writeText(r.url).then(()=>{i.success("封面地址已复制到剪贴板")}).catch(()=>{i.error("复制失败，请手动复制")})},children:"复制地址"},"copy"),t.jsx(d,{type:"primary",icon:t.jsx(qe,{}),onClick:()=>{if(r){const e=r.url.split("."),o=e.length>1?e[e.length-1].split("?")[0]:"jpg",a=`${r.title.replace(/[<>:"/\\|?*]/g,"_")}_cover.${o}`;Ee(r.url,a)}},children:"保存封面"},"download")],width:600,centered:!0,children:r&&t.jsxs("div",{style:{textAlign:"center"},children:[t.jsx(Ue,{src:r.url,alt:r.title,style:{maxWidth:"100%",maxHeight:"400px"},fallback:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RnG4W+FgYxN"}),t.jsxs("div",{style:{marginTop:16,fontSize:14,color:"#666"},children:[t.jsxs("p",{children:[t.jsx("strong",{children:"系列标题："}),r.title]}),t.jsx("p",{children:t.jsx("strong",{children:"封面地址："})}),t.jsx("div",{style:{background:"#f5f5f5",padding:"8px 12px",borderRadius:4,wordBreak:"break-all",fontSize:12,fontFamily:"Monaco, Menlo, monospace"},children:r.url})]})]})})]})}export{We as default};
