import{I as Pe,j as e}from"./index-DxaCQfSk.js";import{r as n,k as Re}from"./react-vendor-BZ8KDC-J.js";import{E as O,S as $e,a as Fe}from"./admin-C9fopLaz.js";import{m as Ne,F as j,s as d,a as fe,B as m,g as N,k as H,d as He,f as A,I as Ae,n as Le}from"./antd-vendor-DXNcJ2Ha.js";import{R as Ve}from"./DownloadOutlined-2HOjhaut.js";import"./utils-vendor-NIGUFBhG.js";function Z(){return Z=Object.assign?Object.assign.bind():function(c){for(var u=1;u<arguments.length;u++){var x=arguments[u];for(var p in x)Object.prototype.hasOwnProperty.call(x,p)&&(c[p]=x[p])}return c},Z.apply(this,arguments)}const qe=(c,u)=>n.createElement(Pe,Z({},c,{ref:u,icon:Ne})),_e=n.forwardRef(qe),{Paragraph:L,Text:r}=Le,Ke=c=>{const u=Math.floor(c/3600),x=Math.floor(c%3600/60),p=c%60;return u>0?`${u}时${x}分${p}秒`:x>0?`${x}分${p}秒`:`${p}秒`};function Xe(){const[c]=Re(),u=Number(c.get("seriesId")||"")||void 0,[x,p]=n.useState(!1),[xe,me]=n.useState([]),[ye,ge]=n.useState(0),[J,je]=n.useState(1),[E,ve]=n.useState(10),[we,C]=n.useState(!1),[k,Q]=n.useState(null),[I]=j.useForm(),[be,V]=n.useState(!1),[B,q]=n.useState(null),[Se,_]=n.useState(!1),[P,K]=n.useState(null),[T,Ce]=n.useState(u),[w,X]=n.useState([]),[b,ee]=n.useState(!1),[te,se]=n.useState(1),[ne,ie]=n.useState(!0),S=n.useRef(void 0),G=n.useRef(""),W=n.useRef(1),[ke,R]=n.useState(!1),[o,Ie]=n.useState(null),[Te,oe]=n.useState(!1),[z,le]=n.useState(void 0),[D,ae]=n.useState(void 0),h=n.useCallback(async(t=J,s=E)=>{p(!0);try{const i={};T&&(i.seriesId=T),z!==void 0&&(i.minDuration=z),D!==void 0&&(i.maxDuration=D);const f=await O.list(t,s,i),l=(f.items||[]).slice().sort((a,g)=>a.seriesId!==g.seriesId?a.seriesId-g.seriesId:a.episodeNumber-g.episodeNumber);me(l),ge(f.total),je(f.page),ve(f.size)}finally{p(!1)}},[T,z,D]);n.useEffect(()=>{h(1,E)},[h]),n.useEffect(()=>{h(1,E)},[T,z,D]);const $=50,y=n.useCallback(async t=>{const s=t?.keyword!==void 0?t.keyword:G.current,i=t?.reset?1:t?.page||W.current;ee(!0);try{if(s&&s.trim()){const l=await $e.fuzzy({keyword:s.trim(),page:i,size:$}),a=l?.data||l,F=(a?.list||a?.items||[]).map(U=>({value:U.id,label:`#${U.id} ${U.title||""}`}));X(U=>t?.reset?F:Array.from(new Map([...U,...F].map(he=>[he.value,he])).values()));const M=a?.page||i;se(M),W.current=M;const pe=a?.total??0,v=a?.size??$;ie(M*v<pe||a?.hasMore===!0)}else{const l=await Fe.list(i,$),a=(l.items||[]).map(v=>({value:v.id,label:`#${v.id} ${v.title||""}`}));X(v=>t?.reset?a:Array.from(new Map([...v,...a].map(Y=>[Y.value,Y])).values()));const g=l.page||i;se(g),W.current=g;const F=l.total??0,M=l.size??$;ie(g*M<F)}const f=t?.keyword!==void 0?t.keyword:G.current;G.current=f||""}catch{}finally{ee(!1)}},[]);n.useEffect(()=>{y({reset:!0})},[y]);const re=n.useCallback(t=>{Q(t),I.setFieldsValue(t),C(!0)},[I]),de=n.useCallback(t=>{q(t),V(!0)},[]),ze=n.useCallback(async()=>{if(B)try{await O.remove(B.id),d.success("已删除"),h()}catch{d.error("删除失败")}finally{V(!1),q(null)}},[B,h]),De=n.useCallback(()=>{V(!1),q(null)},[]),Me=n.useCallback(async()=>{if(!(!k||!P))try{await O.update(k.id,P),d.success("已更新"),C(!1),h()}catch{d.error("修改失败")}finally{_(!1),K(null)}},[k,P,h]),Ue=n.useCallback(()=>{_(!1),K(null)},[]),ce=n.useCallback(async t=>{oe(!0),R(!0);try{const s=await O.getDownloadUrls(t.id);Ie(s)}catch{d.error("获取下载地址失败"),R(!1)}finally{oe(!1)}},[]),ue=n.useCallback((t,s)=>{const i=document.createElement("a");i.href=t,i.download=s,i.target="_blank",document.body.appendChild(i),i.click(),document.body.removeChild(i)},[]),Oe=n.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"系列",dataIndex:"seriesId",width:200,render:t=>{const s=w.find(i=>i.value===t);return s?s.label:`#${t}`}},{title:"集数",dataIndex:"episodeNumber",width:80},{title:"标题",dataIndex:"title",render:t=>e.jsx("span",{className:"text-ellipsis",style:{display:"inline-block",maxWidth:280},children:t})},{title:"时长",dataIndex:"duration",width:120,render:t=>e.jsxs("div",{children:[e.jsx("div",{children:Ke(t)}),e.jsxs("div",{style:{fontSize:12,color:"#999"},children:[t,"秒"]})]})},{title:"状态",dataIndex:"status",width:100,render:t=>t==="published"?"已发布":t==="hidden"?"隐藏":t==="draft"?"草稿":t||"-"},{title:"方向",dataIndex:"isVertical",width:80,render:t=>t?"竖屏":"横屏"},{title:"操作",width:280,render:(t,s)=>e.jsxs(fe,{children:[e.jsx(m,{onClick:()=>re(s),type:"link",children:"编辑"}),e.jsx(m,{onClick:()=>ce(s),type:"link",children:"下载"}),e.jsx(m,{onClick:()=>de(s),danger:!0,type:"link",children:"删除"})]})}],[w,re,de,ce]),Ee=()=>{Q(null),I.resetFields(),C(!0)},Be=async()=>{const t=await I.validateFields();if(k)K(t),_(!0);else try{await O.create(t),d.success("已创建"),C(!1),h()}catch{d.error("创建失败")}};return e.jsxs("div",{className:"page",children:[e.jsxs(fe,{className:"page-toolbar",wrap:!0,children:[e.jsx(m,{type:"primary",onClick:Ee,children:"新建剧集"}),e.jsx(m,{onClick:()=>h(),children:"刷新"}),e.jsx(N,{showSearch:!0,allowClear:!0,placeholder:"筛选系列",style:{width:280},filterOption:!1,options:w,value:T,loading:b,onDropdownVisibleChange:t=>{t&&w.length===0&&!b&&y({reset:!0})},onPopupScroll:t=>{const s=t.target,i=s&&s.scrollHeight-s.offsetHeight>0,f=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,l=s&&s.scrollTop>0;i&&f&&l&&ne&&!b&&y({page:te+1})},onSearch:t=>{S.current&&window.clearTimeout(S.current),S.current=window.setTimeout(()=>{b||y({reset:!0,keyword:(t||"").trim()})},300)},onChange:t=>Ce(t)}),e.jsx(H,{placeholder:"最小时长(秒)",style:{width:140},value:z,onChange:t=>le(t||void 0),min:0}),e.jsx("span",{style:{color:"#999"},children:"~"}),e.jsx(H,{placeholder:"最大时长(秒)",style:{width:140},value:D,onChange:t=>ae(t||void 0),min:0}),e.jsx(m,{onClick:()=>{le(void 0),ae(void 0)},children:"清除时长筛选"})]}),e.jsx(He,{rowKey:"id",loading:x,dataSource:xe,columns:Oe,tableLayout:"fixed",scroll:{x:960},pagination:{current:J,pageSize:E,total:ye,position:["bottomCenter"],onChange:(t,s)=>h(t,s)}}),e.jsx(A,{title:k?"编辑剧集":"新建剧集",open:we,onCancel:()=>C(!1),onOk:Be,okText:"保存",width:720,children:e.jsxs(j,{form:I,layout:"vertical",children:[e.jsx(j.Item,{name:"seriesId",label:"系列",rules:[{required:!0}],children:e.jsx(N,{showSearch:!0,allowClear:!0,placeholder:"搜索系列",filterOption:!1,options:w,loading:b,onDropdownVisibleChange:t=>{t&&w.length===0&&y({reset:!0})},onPopupScroll:t=>{const s=t.target,i=s&&s.scrollHeight-s.offsetHeight>0,f=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,l=s&&s.scrollTop>0;i&&f&&l&&ne&&!b&&y({page:te+1})},onSearch:t=>{S.current&&window.clearTimeout(S.current),S.current=window.setTimeout(()=>{y({reset:!0,keyword:(t||"").trim()})},300)}})}),e.jsx(j.Item,{name:"episodeNumber",label:"集数",rules:[{required:!0}],children:e.jsx(H,{style:{width:"100%"}})}),e.jsx(j.Item,{name:"title",label:"标题",rules:[{required:!0}],children:e.jsx(Ae,{})}),e.jsx(j.Item,{name:"duration",label:"时长(秒)",rules:[{required:!0}],children:e.jsx(H,{style:{width:"100%"}})}),e.jsx(j.Item,{name:"status",label:"状态",children:e.jsx(N,{placeholder:"选择状态",allowClear:!0,options:[{value:"published",label:"已发布"},{value:"hidden",label:"隐藏"},{value:"draft",label:"草稿"}]})}),e.jsx(j.Item,{name:"isVertical",label:"播放方向",initialValue:!1,children:e.jsx(N,{placeholder:"选择播放方向",options:[{value:!1,label:"横屏"},{value:!0,label:"竖屏"}]})})]})}),e.jsx(A,{title:"确认删除",open:be,onOk:ze,onCancel:De,okText:"确认删除",cancelText:"取消",okType:"danger",children:e.jsxs("p",{children:["确定要删除剧集「",B?.title,"」吗？此操作不可撤销。"]})}),e.jsx(A,{title:"确认修改",open:Se,onOk:Me,onCancel:Ue,okText:"确认修改",cancelText:"取消",children:e.jsxs("p",{children:["确定要修改剧集「",P?.title,"」吗？"]})}),e.jsx(A,{title:"剧集下载地址",open:ke,onCancel:()=>R(!1),footer:[e.jsx(m,{onClick:()=>R(!1),children:"关闭"},"close")],width:900,children:Te?e.jsx("div",{style:{textAlign:"center",padding:"60px 0",fontSize:16,color:"#999"},children:"加载中..."}):o?e.jsxs("div",{children:[e.jsx("div",{style:{background:"#f5f5f5",padding:"16px 20px",borderRadius:8,marginBottom:20},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px 24px"},children:[e.jsxs("div",{children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"系列"}),e.jsxs("div",{style:{marginTop:4,fontSize:15},children:[o.seriesTitle," ",e.jsxs(r,{type:"secondary",children:["(#",o.seriesId,")"]})]})]}),e.jsxs("div",{children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"集数"}),e.jsxs("div",{style:{marginTop:4,fontSize:15},children:["第 ",o.episodeNumber," 集"]})]}),e.jsxs("div",{children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"标题"}),e.jsx("div",{style:{marginTop:4,fontSize:15},children:o.episodeTitle})]}),e.jsxs("div",{children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"时长"}),e.jsxs("div",{style:{marginTop:4,fontSize:15},children:[Math.floor(o.duration/60)," 分 ",o.duration%60," 秒"]})]})]})}),o.downloadUrls&&o.downloadUrls.length>0?e.jsx("div",{style:{maxHeight:500,overflowY:"auto",paddingRight:8},children:o.downloadUrls.map((t,s)=>e.jsxs("div",{style:{marginBottom:s<o.downloadUrls.length-1?24:0,paddingBottom:s<o.downloadUrls.length-1?24:0,borderBottom:s<o.downloadUrls.length-1?"1px solid #f0f0f0":"none"},children:[e.jsx("div",{style:{background:"#fafafa",padding:"8px 16px",borderRadius:6,marginBottom:12,display:"inline-block"},children:e.jsx(r,{strong:!0,style:{fontSize:16,color:"#1890ff"},children:t.quality})}),e.jsxs("div",{style:{paddingLeft:12},children:[t.cdnUrl&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:6},children:e.jsx(r,{strong:!0,style:{fontSize:14},children:"视频链接"})}),e.jsx(L,{copyable:{text:t.cdnUrl,onCopy:()=>d.success("已复制视频链接")},ellipsis:{rows:2,expandable:!0},style:{marginBottom:8,padding:"8px 12px",background:"#fff",border:"1px solid #e8e8e8",borderRadius:4,fontSize:13,fontFamily:"Monaco, Menlo, monospace"},children:t.cdnUrl}),e.jsx(m,{type:"primary",icon:e.jsx(Ve,{}),onClick:()=>ue(t.cdnUrl,`${o.episodeTitle}_${t.quality}.mp4`),children:"下载视频"})]}),t.subtitleUrl&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:6},children:e.jsx(r,{strong:!0,style:{fontSize:14},children:"字幕文件"})}),e.jsx(L,{copyable:{text:t.subtitleUrl,onCopy:()=>d.success("已复制字幕地址")},ellipsis:{rows:2,expandable:!0},style:{marginBottom:8,padding:"8px 12px",background:"#fff",border:"1px solid #e8e8e8",borderRadius:4,fontSize:13,fontFamily:"Monaco, Menlo, monospace"},children:t.subtitleUrl}),e.jsx(m,{icon:e.jsx(_e,{}),onClick:()=>ue(t.subtitleUrl,`${o.episodeTitle}_${t.quality}.srt`),children:"下载字幕"})]}),(t.ossUrl||t.originUrl)&&e.jsxs("div",{style:{marginTop:12,paddingTop:12,borderTop:"1px dashed #e8e8e8"},children:[e.jsx(r,{type:"secondary",style:{fontSize:12,marginBottom:8,display:"block"},children:"原始地址"}),t.ossUrl&&e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"OSS: "}),e.jsx(L,{copyable:{text:t.ossUrl,onCopy:()=>d.success("已复制 OSS 地址")},ellipsis:{rows:1,expandable:!0},style:{display:"inline",marginBottom:0,fontSize:12,fontFamily:"Monaco, Menlo, monospace"},children:t.ossUrl})]}),t.originUrl&&e.jsxs("div",{children:[e.jsx(r,{type:"secondary",style:{fontSize:13},children:"原始: "}),e.jsx(L,{copyable:{text:t.originUrl,onCopy:()=>d.success("已复制原始地址")},ellipsis:{rows:1,expandable:!0},style:{display:"inline",marginBottom:0,fontSize:12,fontFamily:"Monaco, Menlo, monospace"},children:t.originUrl})]})]})]})]},t.id))}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx(r,{type:"secondary",children:"暂无可用的下载地址"})})]}):e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx(r,{type:"secondary",children:"无法加载下载信息"})})})]})}export{Xe as default};
