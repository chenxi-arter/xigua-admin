import{I as Ne,j as t}from"./index-BqQ0KmuN.js";import{r as n,k as Le}from"./react-vendor-BZ8KDC-J.js";import{E as M,S as qe,a as ye}from"./admin-1nbZk7RE.js";import{f as ge}from"./format-0Cj3JWJt.js";import{m as Ve,F as S,s as p,T as _e,a as je,B as j,g as F,k as A,d as Ke,f as H,I as Ge,n as Ye}from"./antd-vendor-CCOR70di.js";import{R as Ze}from"./DownloadOutlined-BpHZrK3i.js";import"./utils-vendor-NIGUFBhG.js";function X(){return X=Object.assign?Object.assign.bind():function(f){for(var h=1;h<arguments.length;h++){var x=arguments[h];for(var m in x)Object.prototype.hasOwnProperty.call(x,m)&&(f[m]=x[m])}return f},X.apply(this,arguments)}const Je=(f,h)=>n.createElement(Ne,X({},f,{ref:h,icon:Ve})),Qe=n.forwardRef(Je),{Paragraph:N,Text:d}=Ye,We=f=>{const h=Math.floor(f/3600),x=Math.floor(f%3600/60),m=f%60;return h>0?`${h}时${x}分${m}秒`:x>0?`${x}分${m}秒`:`${m}秒`};function lt(){const[f]=Le(),h=Number(f.get("seriesId")||"")||void 0,[x,m]=n.useState(!1),[we,ve]=n.useState([]),[Se,be]=n.useState(0),[L,Ce]=n.useState(1),[q,Ie]=n.useState(10),ee=n.useRef(1),V=n.useRef(10);n.useEffect(()=>{ee.current=L},[L]),n.useEffect(()=>{V.current=q},[q]);const[ke,k]=n.useState(!1),[T,te]=n.useState(null),[z]=S.useForm(),[Te,_]=n.useState(!1),[O,K]=n.useState(null),[ze,G]=n.useState(!1),[R,Y]=n.useState(null),[U,De]=n.useState(h),[w,Z]=n.useState([]),se=n.useRef([]);n.useEffect(()=>{se.current=w},[w]);const[C,ne]=n.useState(!1),[ie,oe]=n.useState(1),[le,re]=n.useState(!0),I=n.useRef(void 0),J=n.useRef(""),Q=n.useRef(1),[Me,E]=n.useState(!1),[r,Oe]=n.useState(null),[Re,ae]=n.useState(!1),[$,de]=n.useState(void 0),[B,ce]=n.useState(void 0),Ue=async e=>{const s=Array.from(new Set(e.filter(i=>typeof i=="number")));if(s.length===0)return;const o=new Set(se.current.map(i=>i.value)),c=s.filter(i=>!o.has(i));if(c.length!==0)try{const i=await Promise.all(c.map(async l=>{try{const a=await ye.get(l),u=`#${l}${a?.title?` ${a.title}`:""}`;return{value:l,label:u}}catch{return{value:l,label:`#${l}`}}}));i.length>0&&Z(l=>Array.from(new Map([...l,...i].map(a=>[a.value,a])).values()))}catch{}},y=n.useCallback(async(e,s)=>{const o=e??ee.current,c=s??V.current;m(!0);try{const i={};U&&(i.seriesId=U),$!==void 0&&(i.minDuration=$),B!==void 0&&(i.maxDuration=B);const l=await M.list(o,c,i),a=(l.items||[]).slice().sort((u,g)=>u.seriesId!==g.seriesId?u.seriesId-g.seriesId:u.episodeNumber-g.episodeNumber);ve(a),be(l.total),Ce(l.page),Ie(l.size),Ue(a.map(u=>u.seriesId))}finally{m(!1)}},[U,$,B]);n.useEffect(()=>{y(1,V.current)},[y]);const P=50,v=n.useCallback(async e=>{const s=e?.keyword!==void 0?e.keyword:J.current,o=e?.reset?1:e?.page||Q.current;ne(!0);try{if(s&&s.trim()){const i=await qe.fuzzy({keyword:s.trim(),page:o,size:P}),l=i?.data||i,u=(l?.list||l?.items||[]).map(D=>({value:D.id,label:`#${D.id} ${D.title||""}`}));Z(D=>e?.reset?u:Array.from(new Map([...D,...u].map(xe=>[xe.value,xe])).values()));const g=l?.page||o;oe(g),Q.current=g;const me=l?.total??0,b=l?.size??P;re(g*b<me||l?.hasMore===!0)}else{const i=await ye.list(o,P),l=(i.items||[]).map(b=>({value:b.id,label:`#${b.id} ${b.title||""}`}));Z(b=>e?.reset?l:Array.from(new Map([...b,...l].map(W=>[W.value,W])).values()));const a=i.page||o;oe(a),Q.current=a;const u=i.total??0,g=i.size??P;re(a*g<u)}const c=e?.keyword!==void 0?e.keyword:J.current;J.current=c||""}catch{}finally{ne(!1)}},[]);n.useEffect(()=>{v({reset:!0})},[v]);const ue=n.useCallback(e=>{te(e),z.setFieldsValue(e),k(!0)},[z]),pe=n.useCallback(e=>{K(e),_(!0)},[]),Ee=n.useCallback(async()=>{if(O)try{await M.remove(O.id),p.success("已删除"),y()}catch{p.error("删除失败")}finally{_(!1),K(null)}},[O,y]),$e=n.useCallback(()=>{_(!1),K(null)},[]),Be=n.useCallback(async()=>{if(!(!T||!R))try{await M.update(T.id,R),p.success("已更新"),k(!1),y()}catch{p.error("修改失败")}finally{G(!1),Y(null)}},[T,R,y]),Pe=n.useCallback(()=>{G(!1),Y(null)},[]),fe=n.useCallback(async e=>{ae(!0),E(!0);try{const s=await M.getDownloadUrls(e.id);Oe(s)}catch{p.error("获取下载地址失败"),E(!1)}finally{ae(!1)}},[]),he=n.useCallback((e,s)=>{const o=document.createElement("a");o.href=e,o.download=s,o.target="_blank",document.body.appendChild(o),o.click(),document.body.removeChild(o)},[]),Fe=n.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"系列",dataIndex:"seriesTitle",width:220,render:(e,s)=>s.seriesTitle||(()=>{const o=w.find(c=>c.value===s.seriesId);return o?o.label:`#${s.seriesId}`})()},{title:"集数",dataIndex:"episodeNumber",width:80},{title:"标题",dataIndex:"title",width:200,ellipsis:{showTitle:!1},render:e=>t.jsx(_e,{placement:"topLeft",title:e,children:t.jsx("span",{children:e})})},{title:"时长",dataIndex:"duration",width:110,render:e=>t.jsx("span",{title:`${e}秒`,children:We(e)})},{title:"状态",dataIndex:"status",width:100,render:e=>e==="published"?"已发布":e==="hidden"?"隐藏":e==="draft"?"草稿":e||"-"},{title:"方向",dataIndex:"isVertical",width:80,render:e=>e?"竖屏":"横屏"},{title:"创建时间",dataIndex:"createdAt",width:150,render:e=>ge(e)},{title:"更新时间",dataIndex:"updatedAt",width:150,render:e=>ge(e)},{title:"操作",width:280,render:(e,s)=>t.jsxs(je,{children:[t.jsx(j,{onClick:()=>ue(s),type:"link",children:"编辑"}),t.jsx(j,{onClick:()=>fe(s),type:"link",children:"下载"}),t.jsx(j,{onClick:()=>pe(s),danger:!0,type:"link",children:"删除"})]})}],[w,ue,pe,fe]),Ae=()=>{te(null),z.resetFields(),k(!0)},He=async()=>{const e=await z.validateFields();if(T)Y(e),G(!0);else try{await M.create(e),p.success("已创建"),k(!1),y()}catch{p.error("创建失败")}};return t.jsxs("div",{className:"page",children:[t.jsxs(je,{className:"page-toolbar",wrap:!0,children:[t.jsx(j,{type:"primary",onClick:Ae,children:"新建剧集"}),t.jsx(j,{onClick:()=>y(),children:"刷新"}),t.jsx(F,{showSearch:!0,allowClear:!0,placeholder:"筛选系列",style:{width:280},filterOption:!1,options:w,value:U,loading:C,onDropdownVisibleChange:e=>{e&&w.length===0&&!C&&v({reset:!0})},onPopupScroll:e=>{const s=e.target,o=s&&s.scrollHeight-s.offsetHeight>0,c=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,i=s&&s.scrollTop>0;o&&c&&i&&le&&!C&&v({page:ie+1})},onSearch:e=>{I.current&&window.clearTimeout(I.current),I.current=window.setTimeout(()=>{C||v({reset:!0,keyword:(e||"").trim()})},300)},onChange:e=>De(e)}),t.jsx(A,{placeholder:"最小时长(秒)",style:{width:140},value:$,onChange:e=>de(e||void 0),min:0}),t.jsx("span",{style:{color:"#999"},children:"~"}),t.jsx(A,{placeholder:"最大时长(秒)",style:{width:140},value:B,onChange:e=>ce(e||void 0),min:0}),t.jsx(j,{onClick:()=>{de(void 0),ce(void 0)},children:"清除时长筛选"})]}),t.jsx(Ke,{rowKey:"id",loading:x,dataSource:we,columns:Fe,tableLayout:"fixed",scroll:{x:960},pagination:{current:L,pageSize:q,total:Se,position:["bottomCenter"],onChange:(e,s)=>y(e,s)}}),t.jsx(H,{title:T?"编辑剧集":"新建剧集",open:ke,onCancel:()=>k(!1),onOk:He,okText:"保存",width:720,children:t.jsxs(S,{form:z,layout:"vertical",children:[t.jsx(S.Item,{name:"seriesId",label:"系列",rules:[{required:!0}],children:t.jsx(F,{showSearch:!0,allowClear:!0,placeholder:"搜索系列",filterOption:!1,options:w,loading:C,onDropdownVisibleChange:e=>{e&&w.length===0&&v({reset:!0})},onPopupScroll:e=>{const s=e.target,o=s&&s.scrollHeight-s.offsetHeight>0,c=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,i=s&&s.scrollTop>0;o&&c&&i&&le&&!C&&v({page:ie+1})},onSearch:e=>{I.current&&window.clearTimeout(I.current),I.current=window.setTimeout(()=>{v({reset:!0,keyword:(e||"").trim()})},300)}})}),t.jsx(S.Item,{name:"episodeNumber",label:"集数",rules:[{required:!0}],children:t.jsx(A,{style:{width:"100%"}})}),t.jsx(S.Item,{name:"title",label:"标题",rules:[{required:!0}],children:t.jsx(Ge,{})}),t.jsx(S.Item,{name:"duration",label:"时长(秒)",rules:[{required:!0}],children:t.jsx(A,{style:{width:"100%"}})}),t.jsx(S.Item,{name:"status",label:"状态",children:t.jsx(F,{placeholder:"选择状态",allowClear:!0,options:[{value:"published",label:"已发布"},{value:"hidden",label:"隐藏"},{value:"draft",label:"草稿"}]})}),t.jsx(S.Item,{name:"isVertical",label:"播放方向",initialValue:!1,children:t.jsx(F,{placeholder:"选择播放方向",options:[{value:!1,label:"横屏"},{value:!0,label:"竖屏"}]})})]})}),t.jsx(H,{title:"确认删除",open:Te,onOk:Ee,onCancel:$e,okText:"确认删除",cancelText:"取消",okType:"danger",children:t.jsxs("p",{children:["确定要删除剧集「",O?.title,"」吗？此操作不可撤销。"]})}),t.jsx(H,{title:"确认修改",open:ze,onOk:Be,onCancel:Pe,okText:"确认修改",cancelText:"取消",children:t.jsxs("p",{children:["确定要修改剧集「",R?.title,"」吗？"]})}),t.jsx(H,{title:"剧集下载地址",open:Me,onCancel:()=>E(!1),footer:[t.jsx(j,{onClick:()=>E(!1),children:"关闭"},"close")],width:900,children:Re?t.jsx("div",{style:{textAlign:"center",padding:"60px 0",fontSize:16,color:"#999"},children:"加载中..."}):r?t.jsxs("div",{children:[t.jsx("div",{style:{background:"#f5f5f5",padding:"16px 20px",borderRadius:8,marginBottom:20},children:t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px 24px"},children:[t.jsxs("div",{children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"系列"}),t.jsxs("div",{style:{marginTop:4,fontSize:15},children:[r.seriesTitle," ",t.jsxs(d,{type:"secondary",children:["(#",r.seriesId,")"]})]})]}),t.jsxs("div",{children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"集数"}),t.jsxs("div",{style:{marginTop:4,fontSize:15},children:["第 ",r.episodeNumber," 集"]})]}),t.jsxs("div",{children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"标题"}),t.jsx("div",{style:{marginTop:4,fontSize:15},children:r.episodeTitle})]}),t.jsxs("div",{children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"时长"}),t.jsxs("div",{style:{marginTop:4,fontSize:15},children:[Math.floor(r.duration/60)," 分 ",r.duration%60," 秒"]})]})]})}),r.downloadUrls&&r.downloadUrls.length>0?t.jsx("div",{style:{maxHeight:500,overflowY:"auto",paddingRight:8},children:r.downloadUrls.map((e,s)=>t.jsxs("div",{style:{marginBottom:s<r.downloadUrls.length-1?24:0,paddingBottom:s<r.downloadUrls.length-1?24:0,borderBottom:s<r.downloadUrls.length-1?"1px solid #f0f0f0":"none"},children:[t.jsx("div",{style:{background:"#fafafa",padding:"8px 16px",borderRadius:6,marginBottom:12,display:"inline-block"},children:t.jsx(d,{strong:!0,style:{fontSize:16,color:"#1890ff"},children:e.quality})}),t.jsxs("div",{style:{paddingLeft:12},children:[e.cdnUrl&&t.jsxs("div",{style:{marginBottom:16},children:[t.jsx("div",{style:{marginBottom:6},children:t.jsx(d,{strong:!0,style:{fontSize:14},children:"视频链接"})}),t.jsx(N,{copyable:{text:e.cdnUrl,onCopy:()=>p.success("已复制视频链接")},ellipsis:{rows:2,expandable:!0},style:{marginBottom:8,padding:"8px 12px",background:"#fff",border:"1px solid #e8e8e8",borderRadius:4,fontSize:13,fontFamily:"Monaco, Menlo, monospace"},children:e.cdnUrl}),t.jsx(j,{type:"primary",icon:t.jsx(Ze,{}),onClick:()=>he(e.cdnUrl,`${r.episodeTitle}_${e.quality}.mp4`),children:"下载视频"})]}),e.subtitleUrl&&t.jsxs("div",{style:{marginBottom:16},children:[t.jsx("div",{style:{marginBottom:6},children:t.jsx(d,{strong:!0,style:{fontSize:14},children:"字幕文件"})}),t.jsx(N,{copyable:{text:e.subtitleUrl,onCopy:()=>p.success("已复制字幕地址")},ellipsis:{rows:2,expandable:!0},style:{marginBottom:8,padding:"8px 12px",background:"#fff",border:"1px solid #e8e8e8",borderRadius:4,fontSize:13,fontFamily:"Monaco, Menlo, monospace"},children:e.subtitleUrl}),t.jsx(j,{icon:t.jsx(Qe,{}),onClick:()=>he(e.subtitleUrl,`${r.episodeTitle}_${e.quality}.srt`),children:"下载字幕"})]}),(e.ossUrl||e.originUrl)&&t.jsxs("div",{style:{marginTop:12,paddingTop:12,borderTop:"1px dashed #e8e8e8"},children:[t.jsx(d,{type:"secondary",style:{fontSize:12,marginBottom:8,display:"block"},children:"原始地址"}),e.ossUrl&&t.jsxs("div",{style:{marginBottom:8},children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"OSS: "}),t.jsx(N,{copyable:{text:e.ossUrl,onCopy:()=>p.success("已复制 OSS 地址")},ellipsis:{rows:1,expandable:!0},style:{display:"inline",marginBottom:0,fontSize:12,fontFamily:"Monaco, Menlo, monospace"},children:e.ossUrl})]}),e.originUrl&&t.jsxs("div",{children:[t.jsx(d,{type:"secondary",style:{fontSize:13},children:"原始: "}),t.jsx(N,{copyable:{text:e.originUrl,onCopy:()=>p.success("已复制原始地址")},ellipsis:{rows:1,expandable:!0},style:{display:"inline",marginBottom:0,fontSize:12,fontFamily:"Monaco, Menlo, monospace"},children:e.originUrl})]})]})]})]},e.id))}):t.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:t.jsx(d,{type:"secondary",children:"暂无可用的下载地址"})})]}):t.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:t.jsx(d,{type:"secondary",children:"无法加载下载信息"})})})]})}export{lt as default};
