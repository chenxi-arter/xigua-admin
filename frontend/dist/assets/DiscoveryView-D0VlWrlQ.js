import{d as O,r as n,h as Q,i as X,c as b,a as d,j as E,k as F,b as S,F as Z,l as ee,u as te,n as L,o as m,p as oe,q as ae,_ as ne}from"./index-B-NUcGvg.js";import{C as se,V as re}from"./CommentDrawer-CnAEiFTH.js";import{s as a,c as w,L as ie}from"./request-BicgVeyS.js";import{I as le}from"./index-OOe-qU7w.js";import"./index.min-BmcZ0e5Q.js";import"./index-DIRquChx.js";import"./use-route-8j7D0a9D.js";import"./index-DIE1r4Zn.js";import"./use-id-D_qdaRVJ.js";const ce={class:"recommend-container"},ue={class:"top-nav"},ve={class:"nav-left"},de={class:"nav-right"},me=O({__name:"DiscoveryView",setup(pe){const p=te(),A=n(null),i=n([]),o=n(0),u=n(!1),B=n(!1),g=n(0),k=n(0),f=n(!1),h=n(1),y=n(!0),v=n(new Map),Y=(t,e)=>{t&&typeof t=="object"&&"play"in t&&v.value.set(e,t)},R=()=>{p.back()},U=()=>{p.push("/search")},C=async(t=1,e=!1)=>{if(!u.value){u.value=!0;try{if(!localStorage.getItem("Authorization")){a("请先登录"),p.push("/login");return}const s=await w.get("/api/video/recommend",{params:{page:t,size:10}}),c=s.data.data||s.data,r=c.list||[];if(r.length===0){a("暂无推荐内容"),y.value=!1;return}e?i.value=[...i.value,...r]:i.value=r,y.value=c.hasMore??!1,t===1&&r.length>0&&(await L(),_())}catch(l){console.error("加载推荐视频失败:",l),a(l.response?.data?.message||"加载失败，请重试")}finally{u.value=!1}}},_=()=>{const t=v.value.get(o.value);t&&t.play()},M=()=>{const t=v.value.get(o.value);t&&t.pause()},x=t=>{const e=t.target;e.closest(".interaction-panel")||e.closest(".van-popup")||e.closest(".comment-drawer")||e.closest(".van-icon")||e.closest("button")||e.closest('[role="button"]')||(g.value=t.touches[0].clientY,f.value=!0)},N=t=>{if(!f.value)return;const e=t.target;e.closest(".interaction-panel")||e.closest(".van-popup")||e.closest(".comment-drawer")||e.closest(".van-icon")||e.closest("button")||e.closest('[role="button"]')||(k.value=t.touches[0].clientY)},j=async()=>{if(!f.value)return;const t=g.value-k.value;Math.abs(t)>50&&(t>0?await P():await D()),f.value=!1,g.value=0,k.value=0},P=async()=>{if(o.value>=i.value.length-1)if(y.value)h.value++,await C(h.value,!0);else{a("没有更多视频了");return}M(),o.value++,await L(),_(),o.value>=i.value.length-3&&y.value&&!u.value&&(h.value++,C(h.value,!0))},D=async()=>{if(o.value<=0){a("已经是第一个视频了");return}M(),o.value--,await L(),_()},q=t=>{p.push({name:"seriesPlay",params:{id:t}})},K=async t=>{t&&(t.stopPropagation(),t.preventDefault());const e=i.value[o.value];if(!e)return;if(!localStorage.getItem("Authorization")){a("请先登录");return}try{await w.post("/api/video/episode/activity",{shortId:e.shortId,type:"like"}),e.isLiked?(e.likeCount=Math.max(0,(e.likeCount||0)-1),e.isLiked=!1,a("已取消点赞")):(e.likeCount=(e.likeCount||0)+1,e.isLiked=!0,a("点赞成功"))}catch(s){console.error("点赞操作失败:",s),a(s.response?.data?.message||"操作失败")}},W=async t=>{t&&(t.stopPropagation(),t.preventDefault());const e=i.value[o.value];if(!e)return;if(!localStorage.getItem("Authorization")){a("请先登录");return}try{e.isFavorited?(await w.post("/api/user/favorites/remove",{shortId:e.shortId}),e.favoriteCount=Math.max(0,(e.favoriteCount||0)-1),e.isFavorited=!1,a("已取消收藏")):(await w.post("/api/video/episode/activity",{shortId:e.shortId,type:"favorite"}),e.favoriteCount=(e.favoriteCount||0)+1,e.isFavorited=!0,a("收藏成功"))}catch(s){console.error("收藏操作失败:",s),a(s.response?.data?.message||"操作失败")}},V=n(!1),T=n(""),I=n(0),$=t=>{t&&(t.stopPropagation(),t.preventDefault());const e=i.value[o.value];if(!e)return;if(!localStorage.getItem("Authorization")){a("请先登录");return}T.value=e.shortId,I.value=e.commentCount||0,V.value=!0},G=()=>{const t=i.value[o.value];t&&(t.commentCount=(t.commentCount||0)+1,I.value=t.commentCount)},H=()=>{a("分享功能开发中")},z=t=>{t.key==="ArrowUp"?D():t.key==="ArrowDown"&&P()};return Q(()=>{C(1),window.addEventListener("keydown",z)}),X(()=>{window.removeEventListener("keydown",z),v.value.forEach(t=>{t?.destroy()}),v.value.clear()}),(t,e)=>{const l=le,s=ie;return m(),b("div",ce,[d("div",ue,[d("div",ve,[S(l,{name:"arrow-left",onClick:R})]),e[1]||(e[1]=d("div",{class:"nav-title"},"推荐",-1)),d("div",de,[S(l,{name:"search",onClick:U})])]),d("div",{class:"video-swiper",ref_key:"swiperContainer",ref:A,onTouchstart:x,onTouchmove:N,onTouchend:j},[(m(!0),b(Z,null,ee(i.value,(c,r)=>(m(),b("div",{key:c.shortId,class:ae(["video-item",{active:o.value===r}]),style:oe({transform:`translateY(${(r-o.value)*100}vh)`})},[Math.abs(r-o.value)<=1?(m(),E(re,{key:0,ref_for:!0,ref:J=>Y(J,r),"episode-info":c,autoplay:r===o.value,muted:r===o.value&&!B.value,onViewSeries:q,onLike:K,onFavorite:W,onComment:$,onShare:H},null,8,["episode-info","autoplay","muted"])):F("",!0)],6))),128))],544),u.value?(m(),E(s,{key:0,class:"loading-overlay",type:"spinner",color:"#fff"})):F("",!0),S(se,{visible:V.value,"onUpdate:visible":e[0]||(e[0]=c=>V.value=c),"episode-short-id":T.value,"comment-count":I.value,onCommented:G},null,8,["visible","episode-short-id","comment-count"])])}}}),Ie=ne(me,[["__scopeId","data-v-66992834"]]);export{Ie as default};
