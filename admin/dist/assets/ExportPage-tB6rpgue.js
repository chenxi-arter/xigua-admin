import{j as a,d as g}from"./index-Cn3Y4oV4.js";import{r as u}from"./react-vendor-BZ8KDC-J.js";import{c as j}from"./admin-Ch7isWHw.js";import{p as z,a as x,g as F,n as P,B as D,u as A,d as S,s as c}from"./antd-vendor-CqSdqTZY.js";import{R as B}from"./DownloadOutlined-DnzfYxfs.js";import"./utils-vendor-NIGUFBhG.js";const{RangePicker:_}=P,{Title:K,Text:C}=F;function H(){const[r,Y]=u.useState(null),[h,k]=u.useState([]),[y,w]=u.useState([]),[p,v]=u.useState(!1),[R,M]=u.useState("play"),b=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"播放量",dataIndex:"playCount",key:"playCount",width:100,sorter:(t,e)=>t.playCount-e.playCount},{title:"完播率",dataIndex:"completionRate",key:"completionRate",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.completionRate-e.completionRate},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"点赞",dataIndex:"likeCount",key:"likeCount",width:80,sorter:(t,e)=>t.likeCount-e.likeCount},{title:"分享",dataIndex:"shareCount",key:"shareCount",width:80,sorter:(t,e)=>t.shareCount-e.shareCount},{title:"收藏",dataIndex:"favoriteCount",key:"favoriteCount",width:80,sorter:(t,e)=>t.favoriteCount-e.favoriteCount}],I=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"总新增",dataIndex:"newUsers",key:"newUsers",width:100,sorter:(t,e)=>t.newUsers-e.newUsers},{title:"次日留存",dataIndex:"nextDayRetention",key:"nextDayRetention",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.nextDayRetention-e.nextDayRetention},{title:"日活",dataIndex:"dau",key:"dau",width:100,sorter:(t,e)=>t.dau-e.dau},{title:"平均观影时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"新增来源",dataIndex:"newUserSource",key:"newUserSource",width:120}],U=async()=>{if(!r){c.warning("请选择日期范围");return}const[t,e]=r,n=t.format("YYYY-MM-DD"),o=e.format("YYYY-MM-DD");v(!0);try{const[i,d]=await Promise.all([j.getPlayStats({startDate:n,endDate:o}),j.getUserStats({startDate:n,endDate:o})]);i.code===200?k(i.data):c.error(`获取播放数据失败: ${i.message}`),d.code===200?w(d.data):c.error(`获取用户数据失败: ${d.message}`),c.success("数据获取成功")}catch(i){c.error("获取数据失败，请检查网络连接"),console.error("Export data fetch error:",i)}finally{v(!1)}},$=(t,e,n)=>{if(t.length===0){c.warning("没有数据可导出");return}let o="";n?(o=`日期,播放量,完播率,平均观看时长,点赞,分享,收藏
`,t.forEach(s=>{const m=Math.floor(s.avgWatchDuration/60),f=s.avgWatchDuration%60;o+=`${s.date},${s.playCount},${(s.completionRate*100).toFixed(2)}%,${m}分${f}秒,${s.likeCount},${s.shareCount},${s.favoriteCount}
`})):(o=`日期,总新增,次日留存,日活,平均观影时长,新增来源
`,t.forEach(s=>{const m=Math.floor(s.avgWatchDuration/60),f=s.avgWatchDuration%60;o+=`${s.date},${s.newUsers},${(s.nextDayRetention*100).toFixed(2)}%,${s.dau},${m}分${f}秒,${s.newUserSource}
`}));const i="\uFEFF",d=new Blob([i+o],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),E=URL.createObjectURL(d);l.setAttribute("href",E),l.setAttribute("download",`${e}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),c.success("导出成功")},W=()=>{const t=`播放数据统计_${r?.[0].format("YYYYMMDD")}_${r?.[1].format("YYYYMMDD")}`;$(h,t,!0)},T=()=>{const t=`用户数据统计_${r?.[0].format("YYYYMMDD")}_${r?.[1].format("YYYYMMDD")}`;$(y,t,!1)};return a.jsx("div",{className:"page",children:a.jsx(z,{children:a.jsxs(x,{direction:"vertical",size:"large",style:{width:"100%"},children:[a.jsxs("div",{children:[a.jsxs(K,{level:3,children:[a.jsx(g,{})," 运营数据导出"]}),a.jsx(C,{type:"secondary",children:"选择日期范围，查看并导出播放数据和用户数据统计"})]}),a.jsxs(x,{size:"middle",children:[a.jsx(_,{value:r,onChange:t=>Y(t),format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],style:{width:300}}),a.jsx(D,{type:"primary",icon:a.jsx(B,{}),onClick:U,loading:p,children:"获取数据"})]}),a.jsx(A,{activeKey:R,onChange:M,items:[{key:"play",label:"播放数据统计",children:a.jsxs(x,{direction:"vertical",size:"middle",style:{width:"100%"},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsxs(C,{strong:!0,children:["共 ",h.length," 条记录"]}),a.jsx(D,{type:"primary",icon:a.jsx(g,{}),onClick:W,disabled:h.length===0,children:"导出为 CSV"})]}),a.jsx(S,{columns:b,dataSource:h,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:p,scroll:{x:800}})]})},{key:"user",label:"用户数据统计",children:a.jsxs(x,{direction:"vertical",size:"middle",style:{width:"100%"},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsxs(C,{strong:!0,children:["共 ",y.length," 条记录"]}),a.jsx(D,{type:"primary",icon:a.jsx(g,{}),onClick:T,disabled:y.length===0,children:"导出为 CSV"})]}),a.jsx(S,{columns:I,dataSource:y,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:p,scroll:{x:800}})]})}]})]})})})}export{H as default};
