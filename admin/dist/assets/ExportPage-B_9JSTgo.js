import{I as X,j as o,d as I}from"./index-FXvYeR5H.js";import{r as C}from"./react-vendor-BZ8KDC-J.js";import{C as Z,c as R}from"./admin-CbwXIqK2.js";import{y as tt,m as et,a as p,i as at,z as ot,l as nt,f as st,B as S,u as it,g as Y,s as d}from"./antd-vendor-aNvYRewR.js";import{R as A}from"./DownloadOutlined-9bN_21dL.js";import"./client-BbHh6MVO.js";import"./utils-vendor-NIGUFBhG.js";function M(){return M=Object.assign?Object.assign.bind():function(l){for(var m=1;m<arguments.length;m++){var y=arguments[m];for(var f in y)Object.prototype.hasOwnProperty.call(y,f)&&(l[f]=y[f])}return l},M.apply(this,arguments)}const rt=(l,m)=>C.createElement(X,M({},l,{ref:m,icon:tt})),lt=C.forwardRef(rt),{RangePicker:dt}=nt,{Title:ct,Text:j}=at;function xt(){const[l,m]=C.useState(null),[y,f]=C.useState([]),[w,T]=C.useState([]),[x,U]=C.useState([]),[v,E]=C.useState(!1),[W,b]=C.useState(""),[F,P]=C.useState("play"),[L,z]=C.useState(void 0),B=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"播放量",dataIndex:"playCount",key:"playCount",width:100,sorter:(t,e)=>t.playCount-e.playCount},{title:"完播率",dataIndex:"completionRate",key:"completionRate",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.completionRate-e.completionRate},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"点赞",dataIndex:"likeCount",key:"likeCount",width:80,sorter:(t,e)=>t.likeCount-e.likeCount},{title:"分享",dataIndex:"shareCount",key:"shareCount",width:80,sorter:(t,e)=>t.shareCount-e.shareCount},{title:"收藏",dataIndex:"favoriteCount",key:"favoriteCount",width:80,sorter:(t,e)=>t.favoriteCount-e.favoriteCount}],N=[{title:"日期",dataIndex:"date",key:"date",width:120},{title:"总新增",dataIndex:"newUsers",key:"newUsers",width:100,sorter:(t,e)=>t.newUsers-e.newUsers},{title:"次日留存",dataIndex:"nextDayRetention",key:"nextDayRetention",width:100,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.nextDayRetention-e.nextDayRetention},{title:"日活",dataIndex:"dau",key:"dau",width:100,sorter:(t,e)=>t.dau-e.dau},{title:"平均观影时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=t%60;return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"新增来源",dataIndex:"newUserSource",key:"newUserSource",width:120}],k=C.useMemo(()=>{const t=new Map;return x.forEach(e=>{t.has(e.date)||t.set(e.date,[]),t.get(e.date).push(e)}),Array.from(t.entries()).map(([e,n])=>{const s=n.reduce((c,u)=>c+u.playCount,0),h=n.reduce((c,u)=>c+u.completionRate,0)/n.length,r=n.reduce((c,u)=>c+u.avgWatchDuration,0)/n.length,a=n.reduce((c,u)=>c+u.likeCount,0),g=n.reduce((c,u)=>c+u.dislikeCount,0),i=n.reduce((c,u)=>c+u.shareCount,0),D=n.reduce((c,u)=>c+u.favoriteCount,0),$=n.reduce((c,u)=>c+u.commentCount,0);return{date:e,seriesCount:n.length,series:n,totalPlayCount:s,avgCompletionRate:h,avgWatchDuration:r,totalLikeCount:a,totalDislikeCount:g,totalShareCount:i,totalFavoriteCount:D,totalCommentCount:$}}).sort((e,n)=>n.date.localeCompare(e.date))},[x]),_=[{title:"日期",dataIndex:"date",key:"date",width:120,fixed:"left"},{title:"系列数",dataIndex:"seriesCount",key:"seriesCount",width:80},{title:"总播放量",dataIndex:"totalPlayCount",key:"totalPlayCount",width:120,sorter:(t,e)=>t.totalPlayCount-e.totalPlayCount,render:t=>t.toLocaleString()},{title:"平均完播率",dataIndex:"avgCompletionRate",key:"avgCompletionRate",width:120,render:t=>`${(t*100).toFixed(2)}%`,sorter:(t,e)=>t.avgCompletionRate-e.avgCompletionRate},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:t=>{const e=Math.floor(t/60),n=Math.floor(t%60);return`${e}分${n}秒`},sorter:(t,e)=>t.avgWatchDuration-e.avgWatchDuration},{title:"总点赞",dataIndex:"totalLikeCount",key:"totalLikeCount",width:100,sorter:(t,e)=>t.totalLikeCount-e.totalLikeCount,render:t=>t.toLocaleString()},{title:"总踩",dataIndex:"totalDislikeCount",key:"totalDislikeCount",width:100,sorter:(t,e)=>t.totalDislikeCount-e.totalDislikeCount,render:t=>t.toLocaleString()},{title:"总分享",dataIndex:"totalShareCount",key:"totalShareCount",width:100,sorter:(t,e)=>t.totalShareCount-e.totalShareCount,render:t=>t.toLocaleString()},{title:"总收藏",dataIndex:"totalFavoriteCount",key:"totalFavoriteCount",width:100,sorter:(t,e)=>t.totalFavoriteCount-e.totalFavoriteCount,render:t=>t.toLocaleString()},{title:"总评论",dataIndex:"totalCommentCount",key:"totalCommentCount",width:100,sorter:(t,e)=>t.totalCommentCount-e.totalCommentCount,render:t=>t.toLocaleString()}],[K,V]=C.useState([]);C.useEffect(()=>{(async()=>{try{const e=await Z.list();e&&Array.isArray(e)&&V(e)}catch(e){console.error("获取分类列表失败:",e)}})()},[]);const q=async()=>{if(!l){d.warning("请选择日期范围");return}const[t,e]=l,n=t.format("YYYY-MM-DD"),s=e.format("YYYY-MM-DD");E(!0);let h=0,r=[];try{b("正在获取播放数据... (1/3)"),d.loading({content:"正在获取播放数据... (1/3，预计2分钟)",key:"export",duration:0});try{const a=await R.getPlayStats({startDate:n,endDate:s});a.code===200?(f(a.data),h++):r.push(`播放数据: ${a.message}`)}catch(a){console.error("获取播放数据失败:",a),a.code==="ECONNABORTED"||a.message?.includes("timeout")?r.push("播放数据: 请求超时(超过2分钟)"):r.push(`播放数据: ${a.message||"未知错误"}`)}b("正在获取用户数据... (2/3)"),d.loading({content:"正在获取用户数据... (2/3，预计2分钟)",key:"export",duration:0});try{const a=await R.getUserStats({startDate:n,endDate:s});a.code===200?(T(a.data),h++):r.push(`用户数据: ${a.message}`)}catch(a){console.error("获取用户数据失败:",a),a.code==="ECONNABORTED"||a.message?.includes("timeout")?r.push("用户数据: 请求超时(超过2分钟)"):r.push(`用户数据: ${a.message||"未知错误"}`)}b("正在获取系列数据... (3/3)"),d.loading({content:"正在获取系列数据... (3/3，预计3分钟)",key:"export",duration:0});try{const a=await R.getSeriesDetails({startDate:n,endDate:s,categoryId:L});a.code===200?(U(a.data),h++):r.push(`系列数据: ${a.message}`)}catch(a){console.error("获取系列数据失败:",a),a.code==="ECONNABORTED"||a.message?.includes("timeout")?r.push("系列数据: 请求超时(超过3分钟)，数据量过大建议缩短日期范围"):r.push(`系列数据: ${a.message||"未知错误"}`)}b(""),d.destroy("export"),h===3?d.success("所有数据获取成功"):h>0?d.warning({content:`部分数据获取成功 (${h}/3)。失败项: ${r.join("; ")}`,duration:8}):d.error({content:`数据获取失败: ${r.join("; ")}`,duration:8})}catch(a){d.destroy("export"),d.error("获取数据时发生未知错误"),console.error("Export data fetch error:",a)}finally{E(!1)}},O=(t,e,n)=>{if(t.length===0){d.warning("没有数据可导出");return}let s="";n?(s=`日期,播放量,完播率,平均观看时长,点赞,分享,收藏
`,t.forEach(i=>{const D=Math.floor(i.avgWatchDuration/60),$=i.avgWatchDuration%60;s+=`${i.date},${i.playCount},${(i.completionRate*100).toFixed(2)}%,${D}分${$}秒,${i.likeCount},${i.shareCount},${i.favoriteCount}
`})):(s=`日期,总新增,次日留存,日活,平均观影时长,新增来源
`,t.forEach(i=>{const D=Math.floor(i.avgWatchDuration/60),$=i.avgWatchDuration%60;s+=`${i.date},${i.newUsers},${(i.nextDayRetention*100).toFixed(2)}%,${i.dau},${D}分${$}秒,${i.newUserSource}
`}));const h="\uFEFF",r=new Blob([h+s],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),g=URL.createObjectURL(r);a.setAttribute("href",g),a.setAttribute("download",`${e}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a),d.success("导出成功")},G=()=>{const t=`播放数据统计_${l?.[0].format("YYYYMMDD")}_${l?.[1].format("YYYYMMDD")}`;O(y,t,!0)},H=()=>{const t=`用户数据统计_${l?.[0].format("YYYYMMDD")}_${l?.[1].format("YYYYMMDD")}`;O(w,t,!1)},J=()=>{if(k.length===0){d.warning("没有数据可导出");return}let t=`日期,系列数,总播放量,平均完播率,平均观看时长,总点赞,总踩,总分享,总收藏,总评论
`;k.forEach(a=>{const g=Math.floor(a.avgWatchDuration/60),i=Math.floor(a.avgWatchDuration%60);t+=`${a.date},${a.seriesCount},${a.totalPlayCount},${(a.avgCompletionRate*100).toFixed(2)}%,${g}分${i}秒,${a.totalLikeCount},${a.totalDislikeCount},${a.totalShareCount},${a.totalFavoriteCount},${a.totalCommentCount}
`});const e="\uFEFF",n=new Blob([e+t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),h=URL.createObjectURL(n),r=`系列数据汇总_${l?.[0].format("YYYYMMDD")}_${l?.[1].format("YYYYMMDD")}`;s.setAttribute("href",h),s.setAttribute("download",`${r}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),d.success("导出成功")},Q=()=>{if(x.length===0){d.warning("没有数据可导出");return}let t=`日期,系列名称,分类,剧集数,播放量,完播率,平均观看时长,点赞,踩,分享,收藏,评论
`;x.forEach(a=>{const g=Math.floor(a.avgWatchDuration/60),i=Math.floor(a.avgWatchDuration%60);t+=`${a.date},${a.seriesTitle},${a.categoryName},${a.episodeCount},${a.playCount},${(a.completionRate*100).toFixed(2)}%,${g}分${i}秒,${a.likeCount},${a.dislikeCount},${a.shareCount},${a.favoriteCount},${a.commentCount}
`});const e="\uFEFF",n=new Blob([e+t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),h=URL.createObjectURL(n),r=`系列明细数据_${l?.[0].format("YYYYMMDD")}_${l?.[1].format("YYYYMMDD")}`;s.setAttribute("href",h),s.setAttribute("download",`${r}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),d.success("导出成功")};return o.jsx("div",{className:"page",children:o.jsx(et,{children:o.jsxs(p,{direction:"vertical",size:"large",style:{width:"100%"},children:[o.jsxs("div",{children:[o.jsxs(ct,{level:3,children:[o.jsx(I,{})," 运营数据导出"]}),o.jsx(j,{type:"secondary",children:"选择日期范围，查看并导出播放数据和用户数据统计"})]}),v&&W&&o.jsx(ot,{message:W,description:"数据量较大时可能需要较长时间，请耐心等待。如果超时，建议缩短日期范围。",type:"info",icon:o.jsx(lt,{}),showIcon:!0}),o.jsxs(p,{size:"middle",wrap:!0,children:[o.jsx(dt,{value:l,onChange:t=>m(t),format:"YYYY-MM-DD",placeholder:["开始日期","结束日期"],style:{width:300}}),F==="series"&&o.jsx(st,{placeholder:"选择分类（可选）",allowClear:!0,value:L,onChange:z,style:{width:200},options:[{label:"全部分类",value:void 0},...K.map(t=>({label:t.name,value:t.id}))]}),o.jsx(S,{type:"primary",icon:o.jsx(A,{}),onClick:q,loading:v,children:"获取数据"})]}),o.jsx(it,{activeKey:F,onChange:P,items:[{key:"play",label:"播放数据统计",children:o.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(j,{strong:!0,children:["共 ",y.length," 条记录"]}),o.jsx(S,{type:"primary",icon:o.jsx(I,{}),onClick:G,disabled:y.length===0,children:"导出为 CSV"})]}),o.jsx(Y,{columns:B,dataSource:y,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:v,scroll:{x:800}})]})},{key:"user",label:"用户数据统计",children:o.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(j,{strong:!0,children:["共 ",w.length," 条记录"]}),o.jsx(S,{type:"primary",icon:o.jsx(I,{}),onClick:H,disabled:w.length===0,children:"导出为 CSV"})]}),o.jsx(Y,{columns:N,dataSource:w,rowKey:"date",pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 条`},loading:v,scroll:{x:800}})]})},{key:"series",label:"系列明细数据",children:o.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsxs(p,{children:[o.jsxs(j,{strong:!0,children:["共 ",k.length," 天"]}),o.jsxs(j,{type:"secondary",children:["(",x.length," 条系列记录)"]})]}),o.jsxs(p,{children:[o.jsx(S,{type:"primary",icon:o.jsx(A,{}),onClick:J,disabled:k.length===0,children:"导出为 CSV（按日期汇总）"}),o.jsx(S,{icon:o.jsx(I,{}),onClick:Q,disabled:x.length===0,children:"导出明细（含所有系列）"})]})]}),o.jsx(Y,{columns:_,dataSource:k,rowKey:"date",expandable:{expandedRowRender:t=>o.jsx(Y,{columns:[{title:"系列名称",dataIndex:"seriesTitle",key:"seriesTitle",width:200},{title:"分类",dataIndex:"categoryName",key:"categoryName",width:100},{title:"剧集数",dataIndex:"episodeCount",key:"episodeCount",width:80},{title:"播放量",dataIndex:"playCount",key:"playCount",width:100,render:e=>e.toLocaleString()},{title:"完播率",dataIndex:"completionRate",key:"completionRate",width:100,render:e=>`${(e*100).toFixed(2)}%`},{title:"平均观看时长",dataIndex:"avgWatchDuration",key:"avgWatchDuration",width:120,render:e=>{const n=Math.floor(e/60),s=Math.floor(e%60);return`${n}分${s}秒`}},{title:"点赞",dataIndex:"likeCount",key:"likeCount",width:80},{title:"踩",dataIndex:"dislikeCount",key:"dislikeCount",width:80},{title:"分享",dataIndex:"shareCount",key:"shareCount",width:80},{title:"收藏",dataIndex:"favoriteCount",key:"favoriteCount",width:80},{title:"评论",dataIndex:"commentCount",key:"commentCount",width:80}],dataSource:t.series,rowKey:e=>`${e.seriesId}`,pagination:!1,size:"small"}),rowExpandable:t=>t.series.length>0},pagination:{pageSize:20,showSizeChanger:!0,showTotal:t=>`共 ${t} 天`},loading:v,scroll:{x:1200}})]})}]})]})})})}export{xt as default};
