import{j as t}from"./index-BqQ0KmuN.js";import{r as i}from"./react-vendor-BZ8KDC-J.js";import{C as Ve,S as Ge,a as ce,B as g}from"./admin-1nbZk7RE.js";import{F as d,j as ue,s as o,h as me,B as y,i as N,a as M,g as Y,d as Ne,f as K,I as b,U as Ye,k as Ke,l as ge}from"./antd-vendor-CCOR70di.js";import{f as he}from"./format-0Cj3JWJt.js";import"./utils-vendor-NIGUFBhG.js";function et(){const U=e=>!!e&&/^(https?:)?\/\//i.test(e),[pe,J]=i.useState(!1),[Ae,fe]=i.useState([]),[ye,xe]=i.useState(0),[x,W]=i.useState(1),[p,Ie]=i.useState(10),[we,w]=i.useState(!1),[r,_]=i.useState(null),[m]=d.useForm(),j=d.useWatch("isAd",m),[$,Z]=i.useState(!1),[je,X]=i.useState(!1),[C,ee]=i.useState(""),[Se,O]=i.useState(!1),[T,Q]=i.useState(null),[ve,q]=i.useState(!1),[E,z]=i.useState(null),[te,h]=i.useState(null),[se,S]=i.useState([]),[B,ke]=i.useState(void 0),[D,ae]=i.useState(!1),[be,ie]=i.useState(1),[Ue,le]=i.useState(!0),H=i.useRef(void 0),V=i.useRef(""),G=i.useRef(1),[Ce,Te]=i.useState([]),[ne,Ee]=i.useState({}),Be=i.useCallback(async()=>{try{const e=await Ve.list(1,200),s=(e.items||[]).map(a=>({value:a.id,label:a.name||String(a.categoryId||a.id)}));Te(s);const n={};(e.items||[]).forEach(a=>{const l=a.name||String(a.categoryId||a.id);n[String(a.id)]=l,a.categoryId!==void 0&&a.categoryId!==null&&(n[String(a.categoryId)]=l)}),Ee(n)}catch{}},[]),L=50,R=i.useCallback(async e=>{const s=e?.keyword!==void 0?e.keyword:V.current,n=e?.reset?1:e?.page||G.current;ae(!0);try{if(s&&s.trim()){const a=await Ge.fuzzy({keyword:s.trim(),page:n,size:L}),l=a?.data||a,P=(l?.list||l?.items||[]).map(u=>({value:u.id,label:`#${u.id} ${u.title||""}`}));e?.reset?S(P):S(u=>{const k=new Map;return u.forEach(f=>k.set(f.value,f.label)),P.forEach(f=>k.set(f.value,f.label)),Array.from(k.entries()).map(([f,He])=>({value:f,label:He}))});const v=l?.page||n;V.current=s||"",ie(v),G.current=v;const de=l?.total??0,A=l?.size??L;le(v*A<de||l?.hasMore===!0)}else{const a=await ce.list(n,L),l=(a.items||[]).map(A=>({value:A.id,label:`#${A.id} ${A.title||""}`}));e?.reset?S(l):S(A=>{const F=new Map;return A.forEach(u=>F.set(u.value,u.label)),l.forEach(u=>F.set(u.value,u.label)),Array.from(F.entries()).map(([u,k])=>({value:u,label:k}))});const I=a.page||n;V.current="",ie(I),G.current=I;const P=a.total??0,v=a.size??L;le(I*v<P)}}catch{}finally{ae(!1)}},[]),c=i.useCallback(async(e=x,s=p,n=B)=>{J(!0);try{const a=await g.list(e,s);let l=a.items;n!==void 0&&(l=a.items.filter(I=>I.isAd===n)),fe(l),xe(n!==void 0?l.length:a.total),W(e),Ie(s)}finally{J(!1)}},[x,p,B]);i.useEffect(()=>{c(1,p),R({reset:!0}),Be()},[]);const re=i.useCallback(e=>{_(e),m.setFieldsValue({...e,startTime:e.startTime?ue(e.startTime):null,endTime:e.endTime?ue(e.endTime):null}),e.imageUrl&&U(e.imageUrl)&&h(e.imageUrl),e.seriesId&&(async()=>{try{const s=await ce.get(e.seriesId),n={value:s.id,label:`#${s.id} ${s.title||""}`};S(a=>a.find(l=>l.value===n.value)?a:[n,...a])}catch{}})(),w(!0)},[m]),oe=i.useCallback(e=>{Q(e),O(!0)},[]),De=i.useCallback(async()=>{if(T)try{await g.remove(T.id),o.success("å·²åˆ é™¤"),c()}catch{o.error("åˆ é™¤å¤±è´¥")}finally{O(!1),Q(null)}},[T,c]),Le=i.useCallback(()=>{O(!1),Q(null)},[]),Re=i.useCallback(async()=>{if(!(!r||!E))try{await g.update(r.id,E),o.success("å·²æ›´æ–°"),w(!1),h(null),c()}catch{o.error("ä¿®æ”¹å¤±è´¥")}finally{q(!1),z(null)}},[r,E,c]),Pe=i.useCallback(()=>{q(!1),z(null)},[]),Fe=i.useMemo(()=>[{title:"ID",dataIndex:"id",width:80},{title:"æ ‡é¢˜",dataIndex:"title",width:240,render:e=>t.jsx("span",{className:"text-ellipsis",style:{display:"inline-block",maxWidth:240},children:e})},{title:"å›¾ç‰‡",width:260,render:(e,s)=>U(s.imageUrl)?t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx(me,{src:s.imageUrl,alt:"banner",width:80,height:48,style:{objectFit:"cover",borderRadius:4}}),s.linkUrl&&t.jsx(y,{type:"link",onClick:()=>ze(s),children:"æ‰“å¼€"})]}):"-"},{title:"åˆ†ç±»",dataIndex:"categoryId",width:140,render:(e,s)=>ne[String(s.categoryId)]||s.categoryId},{title:"ç³»åˆ—ID",dataIndex:"seriesId",width:100},{title:"æƒé‡",dataIndex:"weight",width:120,render:e=>e??"-"},{title:"ç±»å‹",dataIndex:"isAd",render:e=>e?"å¹¿å‘Š":"å…³è”å‰§é›†",width:80},{title:"å¯ç”¨",dataIndex:"isActive",width:100,render:(e,s)=>t.jsx(N,{checked:!!e,onChange:async n=>{try{await g.updateStatus(s.id,n),o.success(n?"å·²å¯ç”¨":"å·²ç¦ç”¨"),c()}catch{o.error("æ›´æ–°çŠ¶æ€å¤±è´¥")}}})},{title:"æ›å…‰",dataIndex:"impressions",width:100},{title:"ç‚¹å‡»",dataIndex:"clicks",width:100},{title:"å¼€å§‹æ—¶é—´",dataIndex:"startTime",width:180,render:e=>he(e)},{title:"ç»“æŸæ—¶é—´",dataIndex:"endTime",width:180,render:e=>he(e)},{title:"æ“ä½œ",width:220,render:(e,s)=>t.jsxs(M,{children:[t.jsx(y,{onClick:()=>re(s),type:"link",children:"ç¼–è¾‘"}),t.jsx(y,{onClick:()=>oe(s),danger:!0,type:"link",children:"åˆ é™¤"})]})}],[re,oe,ne,c]),Me=()=>{_(null),m.resetFields(),h(null),w(!0)},Oe=async()=>{const e=await m.validateFields(),s=a=>a?new Date(a.valueOf()).toISOString():void 0,n={...e,startTime:s(e.startTime),endTime:s(e.endTime)};if(e.isAd?delete n.seriesId:delete n.linkUrl,r)z(n),q(!0);else try{const a={title:e.title,imageUrl:e.imageUrl,categoryId:e.categoryId,weight:e.weight,isActive:e.isActive,isAd:e.isAd,startTime:s(e.startTime),endTime:s(e.endTime),description:e.description,linkUrl:e.isAd?e.linkUrl:void 0,seriesId:e.isAd?void 0:e.seriesId};await g.create(a),o.success("å·²åˆ›å»º"),w(!1),h(null),c()}catch{o.error("åˆ›å»ºå¤±è´¥")}},Qe=async e=>{const{file:s,onSuccess:n,onError:a}=e;if(!r){o.warning("æ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡"),a?.(new Error("æ–°å»ºæ¨¡å¼ä¸æ”¯æŒæ–‡ä»¶ä¸Šä¼ "));return}try{Z(!0),await g.uploadImage(r.id,s);const l=await g.get(r.id);m.setFieldsValue({imageUrl:l.imageUrl}),h(l.imageUrl),o.success("å›¾ç‰‡å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨"),c(x,p),n?.({})}catch(l){a?.(l instanceof Error?l:new Error(String(l))),o.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥")}finally{Z(!1)}},qe=async()=>{if(!r){o.warning("æ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡");return}if(!C||!/^https?:\/\//i.test(C)){o.warning("è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡ URL");return}try{X(!0),await g.imageFromUrl(r.id,C.trim());const e=await g.get(r.id);m.setFieldsValue({imageUrl:e.imageUrl}),h(e.imageUrl),o.success("å·²é€šè¿‡ URL æ›´æ–°å›¾ç‰‡"),ee(""),c(x,p)}catch{o.error("é€šè¿‡ URL ä¸Šä¼ å›¾ç‰‡å¤±è´¥")}finally{X(!1)}},ze=e=>{e.linkUrl&&(window.open(e.linkUrl,"_blank"),g.click(e.id))};return t.jsxs("div",{className:"page",children:[t.jsxs(M,{className:"page-toolbar",children:[t.jsx(y,{type:"primary",onClick:Me,children:"æ–°å»ºè½®æ’­å›¾"}),t.jsx(Y,{placeholder:"ç­›é€‰ç±»å‹",style:{width:120},allowClear:!0,value:B,onChange:e=>{ke(e),W(1),c(1,p,e)},options:[{value:!0,label:"å¹¿å‘Š"},{value:!1,label:"å…³è”å‰§é›†"}]}),t.jsx(y,{onClick:()=>c(x,p,B),children:"åˆ·æ–°"})]}),t.jsx(Ne,{rowKey:"id",loading:pe,dataSource:Ae,columns:Fe,scroll:{x:1100,y:"calc(100vh - 300px)"},tableLayout:"fixed",pagination:{current:x,pageSize:p,total:ye,position:["bottomCenter"],onChange:(e,s)=>c(e,s)}}),t.jsx(K,{title:r?"ç¼–è¾‘è½®æ’­å›¾":"æ–°å»ºè½®æ’­å›¾",open:we,onCancel:()=>{w(!1),h(null)},onOk:Oe,okText:"ä¿å­˜",width:720,children:t.jsxs(d,{form:m,layout:"vertical",children:[t.jsx(d.Item,{name:"title",label:"æ ‡é¢˜",rules:[{required:!0}],children:t.jsx(b,{})}),t.jsx(d.Item,{name:"isAd",label:"å¹¿å‘Š/å…³è”å‰§é›†",valuePropName:"checked",initialValue:!1,children:t.jsx(N,{checkedChildren:"å¹¿å‘Š",unCheckedChildren:"å…³è”å‰§é›†",onChange:e=>{e?m.setFieldsValue({seriesId:void 0}):m.setFieldsValue({linkUrl:void 0})}})}),t.jsx(d.Item,{name:"imageUrl",label:"å›¾ç‰‡URL",rules:[{required:!0}],children:t.jsx(b,{placeholder:"å¯ç›´æ¥å¡«å†™å›¾ç‰‡ URLï¼Œæˆ–åœ¨ä¸‹æ–¹é€‰æ‹©å›¾ç‰‡æ–‡ä»¶",onChange:e=>{const s=e.target.value;s&&U(s)?h(s):s||h(null)}})}),(te||r?.imageUrl&&U(r.imageUrl))&&t.jsxs("div",{style:{marginBottom:16,textAlign:"center"},children:[t.jsx("div",{style:{fontSize:14,color:"#666",marginBottom:8},children:"å›¾ç‰‡é¢„è§ˆï¼š"}),t.jsx(me,{src:te||r?.imageUrl,alt:"banner preview",style:{maxWidth:"100%",maxHeight:200,objectFit:"contain"},fallback:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Ik1RnG4W+FgYxN"})]}),r&&t.jsx("div",{style:{marginBottom:16},children:t.jsxs(M,{align:"start",style:{width:"100%",justifyContent:"space-between"},children:[t.jsx(Ye,{accept:"image/*",showUploadList:!1,customRequest:Qe,disabled:$,children:t.jsx(y,{loading:$,children:"ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶"})}),t.jsxs(M,{children:[t.jsx(b,{placeholder:"é€šè¿‡å›¾ç‰‡ URL æ›´æ–°",style:{width:320},value:C,onChange:e=>ee(e.target.value)}),t.jsx(y,{loading:je,onClick:qe,children:"æ›´æ–°å›¾ç‰‡"})]})]})}),!r&&t.jsx("div",{style:{marginBottom:16,padding:"12px 16px",background:"#f6f8fa",borderRadius:6,border:"1px solid #e1e4e8"},children:t.jsx("div",{style:{fontSize:14,color:"#586069",marginBottom:8},children:"ğŸ’¡ æç¤ºï¼šæ–°å»ºè½®æ’­å›¾æ—¶è¯·ç›´æ¥å¡«å†™å›¾ç‰‡URLï¼Œåˆ›å»ºå®Œæˆåå¯åœ¨ç¼–è¾‘é¡µé¢ä¿®æ”¹å›¾ç‰‡"})}),t.jsx(d.Item,{name:"categoryId",label:"åˆ†ç±»",rules:[{required:!0}],children:t.jsx(Y,{options:Ce,placeholder:"é€‰æ‹©åˆ†ç±»"})}),t.jsx(d.Item,{name:"seriesId",label:"å…³è”ç³»åˆ—",hidden:j===!0,rules:j?[]:[{required:!0,message:"è¯·é€‰æ‹©å…³è”çš„ç³»åˆ—"}],children:t.jsx(Y,{showSearch:!0,allowClear:!0,placeholder:"æœç´¢ç³»åˆ—åç§°",filterOption:!1,options:se,loading:D,onDropdownVisibleChange:e=>{e&&se.length===0&&!D&&R({reset:!0})},onPopupScroll:e=>{const s=e.target,n=s&&s.scrollHeight-s.offsetHeight>0,a=s&&s.scrollTop+s.offsetHeight>=s.scrollHeight-20,l=s&&s.scrollTop>0;n&&a&&l&&Ue&&!D&&R({page:be+1})},onSearch:e=>{H.current&&window.clearTimeout(H.current),H.current=window.setTimeout(()=>{D||R({reset:!0,keyword:(e||"").trim()})},300)}})}),t.jsx(d.Item,{name:"linkUrl",label:j?"å¹¿å‘Šé“¾æ¥":"è·³è½¬é“¾æ¥(å¯é€‰)",rules:j?[{required:!0,message:"è¯·å¡«å†™å¹¿å‘Šé“¾æ¥"},{type:"url",message:"è¯·è¾“å…¥åˆæ³•çš„ URL"}]:[],children:t.jsx(b,{placeholder:j?"https://example.com":"å¯é€‰"})}),t.jsx(d.Item,{name:"weight",label:"æƒé‡",children:t.jsx(Ke,{style:{width:"100%"}})}),t.jsx(d.Item,{name:"startTime",label:"å¼€å§‹æ—¶é—´",children:t.jsx(ge,{showTime:!0,style:{width:"100%"}})}),t.jsx(d.Item,{name:"endTime",label:"ç»“æŸæ—¶é—´",children:t.jsx(ge,{showTime:!0,style:{width:"100%"}})}),t.jsx(d.Item,{name:"description",label:"æè¿°",children:t.jsx(b.TextArea,{rows:3})}),t.jsx(d.Item,{name:"isActive",label:"å¯ç”¨",valuePropName:"checked",initialValue:!0,children:t.jsx(N,{})})]})}),t.jsx(K,{title:"ç¡®è®¤åˆ é™¤",open:Se,onOk:De,onCancel:Le,okText:"ç¡®è®¤åˆ é™¤",cancelText:"å–æ¶ˆ",okType:"danger",children:t.jsxs("p",{children:["ç¡®å®šè¦åˆ é™¤è½®æ’­å›¾ã€Œ",T?.title,"ã€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"]})}),t.jsx(K,{title:"ç¡®è®¤ä¿®æ”¹",open:ve,onOk:Re,onCancel:Pe,okText:"ç¡®è®¤ä¿®æ”¹",cancelText:"å–æ¶ˆ",children:t.jsxs("p",{children:["ç¡®å®šè¦ä¿®æ”¹è½®æ’­å›¾ã€Œ",E?.title,"ã€å—ï¼Ÿ"]})})]})}export{et as default};
